<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Eurojackpot â€¢ ULTRA CYBER</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
:root{
  --bg:#060a17;
  --panel1:#0c1230;
  --panel2:#0a1026;
  --ink:#eaf2ff;
  --mut:#9fb1e6;
  --gl1:#3cff93;
  --gl2:#39ffd7;
  --gl3:#7c5cff;
  --err:#ff5a8a;
  --ok:#37ffb0;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  background:
    radial-gradient(40rem 40rem at 120% -10%, rgba(124,92,255,.18),transparent 60%),
    radial-gradient(45rem 45rem at -10% 120%, rgba(57,255,215,.12),transparent 60%),
    var(--bg);
  color:var(--ink);
  overflow-x:hidden;
}
.bg-grid::before, .bg-grid::after{
  content:""; position:fixed; inset:-200vmax; pointer-events:none; z-index:-1;
  background:
    linear-gradient(90deg, rgba(124,92,255,.12) 1px, transparent 1px) 0 0/40px 40px,
    linear-gradient(0deg, rgba(57,255,215,.1) 1px, transparent 1px) 0 0/40px 40px;
  animation:gridMove 22s linear infinite;
}
.bg-grid::after{ filter:blur(1.5px); opacity:.6; animation-duration:36s; }
@keyframes gridMove{to{transform:translate3d(60px,40px,0)}}
.hero{
  position:relative; padding:20px; border-radius:22px;
  background:linear-gradient(180deg,var(--panel1),var(--panel2));
  border:1px solid rgba(143,170,255,.25);
  box-shadow:0 24px 60px rgba(0,0,0,.45), inset 0 0 90px rgba(124,92,255,.05);
}
.badge-cy{border:1px solid rgba(143,170,255,.35); border-radius:999px; padding:.25rem .6rem; font-size:.8rem}
.btn-cy{
  background:linear-gradient(90deg,var(--gl2),var(--gl3));
  border:none; color:#0b1026; font-weight:900; text-transform:uppercase; letter-spacing:.08em;
  box-shadow:0 8px 40px rgba(57,255,215,.35), inset 0 0 20px rgba(255,255,255,.3);
}
.btn-cy:hover{filter:brightness(1.08)}
.cardx{
  background:linear-gradient(180deg,var(--panel1),var(--panel2));
  border:1px solid rgba(143,170,255,.22); border-radius:18px; padding:12px; margin-bottom:12px;
  box-shadow:0 12px 32px rgba(0,0,0,.35);
}
.chip{display:inline-flex;min-width:24px;height:24px;border-radius:8px;align-items:center;justify-content:center;margin:2px 3px;padding:0 7px;background:#121b42;border:1px solid rgba(143,170,255,.25);font-weight:800}
.chip.e{background:#13233e}
.chip.typing{box-shadow:0 0 0 2px var(--ok),0 0 18px var(--ok)}
.chip.done{box-shadow:0 0 0 2px var(--gl2),0 0 12px var(--gl2)}
.band{border:1px solid rgba(143,170,255,.2);border-radius:12px;padding:6px 8px;margin-bottom:6px}
.grad{height:6px;border-radius:999px;background:linear-gradient(90deg,#6ea0ff,#7c5cff);margin-bottom:6px}
.grad.g2{background:linear-gradient(90deg,#6bffc0,#0aa771)}
.grad.g3{background:linear-gradient(90deg,#d19aff,#6f36ff)}
.grad.g4{background:linear-gradient(90deg,#ffd36b,#c67a00)}
.grad.g5{background:linear-gradient(90deg,#ff8989,#c32020)}
.grad.ge1{background:linear-gradient(90deg,#ffe066,#9c7a00)}
.grad.ge2{background:linear-gradient(90deg,#66ffe6,#0aa3a3)}
.sticky{position:fixed;left:0;right:0;bottom:0;background:rgba(10,16,40,.94);border-top:1px solid rgba(143,170,255,.22);backdrop-filter:blur(8px);z-index:6}
.progress-neon{height:8px;background:rgba(143,170,255,.18);border-radius:999px;overflow:hidden}
.progress-neon>i{display:block;height:100%;background:linear-gradient(90deg,var(--gl1),var(--gl3));width:0%}
.overlay{position:fixed;inset:0;background:rgba(5,10,20,.7);display:none;align-items:center;justify-content:center;z-index:10;backdrop-filter:blur(4px)}
.holo{width:240px;height:240px;border-radius:50%;border:2px solid rgba(124,92,255,.35);box-shadow: inset 0 0 40px rgba(57,255,215,.25),0 0 40px rgba(124,92,255,.25);display:flex;align-items:center;justify-content:center;color:#dfe8ff;font-weight:900;letter-spacing:.2em}
.pill{font-size:.78rem;border:1px solid rgba(143,170,255,.35);border-radius:999px;padding:.15rem .55rem}
.drop{
  margin-top:12px;border:2px dashed rgba(143,170,255,.35); border-radius:14px; padding:18px; text-align:center; color:#9fb1e6;
  background:rgba(12,18,46,.35);
}
.drop.drag{border-color:#39ffd7; box-shadow: 0 0 0 2px rgba(57,255,215,.3) inset, 0 0 22px rgba(57,255,215,.25)}
</style>
</head>
<body class="bg-grid">
<div class="container py-3 pb-5">
  <div class="hero mb-3">
    <div class="d-flex align-items-center justify-content-between flex-wrap">
      <h3 class="m-0">EUROJACKPOT â€¢ ULTRA CYBER</h3>
      <span class="badge-cy">Status: <span id="ast" class="text-info">Kein Archiv</span></span>
    </div>
    <p class="mt-2 mb-2 text-secondary">Mit einem Klick zum offiziellen Archiv â€“ danach die Datei hier per Drag&Drop ablegen.</p>
    <div class="d-flex gap-2 flex-wrap">
      <a id="goArchive" class="btn btn-cy" href="https://www.lotto-bayern.de/static/gamebroker_2/de/download_files/archiv_eurojackpot.zip" target="_blank" rel="noopener">ðŸ“¥ Archiv laden</a>
      <span class="pill">oder Datei unten ablegen</span>
    </div>
    <div id="drop" class="drop">ZIP/TXT/CSV hierher ziehen oder <label class="text-info" style="text-decoration:underline;cursor:pointer"><input id="file" type="file" accept=".zip,.txt,.csv" hidden>Datei auswÃ¤hlen</label></div>
    <div class="row text-center mt-2">
      <div class="col-3"><div class="small text-secondary">Ziehungen</div><div id="kCount" class="fw-bold">â€“</div></div>
      <div class="col-3"><div class="small text-secondary">Von</div><div id="kFrom" class="fw-bold">â€“</div></div>
      <div class="col-3"><div class="small text-secondary">Bis</div><div id="kTo" class="fw-bold">â€“</div></div>
      <div class="col-3"><div class="small text-secondary">Aktuell?</div><div id="kFresh" class="fw-bold">â€“</div></div>
    </div>
  </div>

  <div class="cardx">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">Karte (1â€“50) & Euro (1â€“12)</h5>
      <span id="label" class="pill">Bereit</span>
    </div>
    <div class="progress-neon my-2"><i id="pbar"></i></div>
    <div id="mwrap"></div>
    <h6 class="mt-2">Eurozahlen</h6>
    <div id="ewrap"></div>
  </div>

  <div class="row g-2">
    <div class="col-lg-6">
      <div class="cardx">
        <h5>Einstellungen</h5>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label small">Kombinationen</label>
            <select id="n" class="form-select form-select-sm"></select>
          </div>
          <div class="col-6">
            <label class="form-label small">Modus</label>
            <select id="mode" class="form-select form-select-sm">
              <option value="never">Nie gezogene</option>
              <option value="last100">Letzte 100</option>
              <option value="hot">Hot Paare/Triples</option>
              <option value="groups">5er-Gruppen</option>
              <option value="complex">Komplex</option>
              <option value="runs">Folgen-Zahlen</option>
            </select>
          </div>
        </div>
        <div id="groups" class="mt-2" style="display:none">
          <div class="d-flex justify-content-between align-items-center">
            <div class="small text-secondary">Summe â‰¤ 5</div>
            <div id="gc" class="pill">0/â‰¤5</div>
          </div>
          <div id="gCtrls" class="mt-1"></div>
          <div class="form-check form-switch mt-2">
            <input id="euroOn" class="form-check-input" type="checkbox">
            <label class="form-check-label" for="euroOn">Eurozahlen manuell (0/2)</label>
          </div>
          <div id="eCtrls" class="mt-1" style="display:none"></div>
        </div>
        <div id="note" class="small text-info mt-1">Eurozahlen werden automatisch auf 2 gesetzt (auÃŸer im Gruppenmodus mit Schalter).</div>
      </div>

      <div class="cardx">
        <h5>Analyse</h5>
        <div class="row g-1">
          <div class="col-9"><input id="wishM" class="form-control form-control-sm" placeholder="5 Hauptzahlen z. B. 1 12 23 34 45"></div>
          <div class="col-3"><input id="wishE" class="form-control form-control-sm" placeholder="Euro (0/2)"></div>
        </div>
        <div class="mt-2 d-flex gap-2 flex-wrap">
          <button id="analyseTip" class="btn btn-success btn-sm">Tipp analysieren</button>
          <button id="fromLast" class="btn btn-outline-light btn-sm">Aus letzter Variante</button>
          <button id="analyseAll" class="btn btn-outline-info btn-sm">Alle Varianten analysieren</button>
        </div>
        <div id="ana" class="mt-2 small"></div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="cardx">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="m-0">Generieren</h5>
          <div id="prog" class="small">â€“</div>
        </div>
        <div id="live" class="mt-2" style="height:140px;overflow:auto;background:#0d1933;border:1px solid rgba(143,170,255,.2);border-radius:8px;padding:8px;font-family:ui-monospace,Consolas"></div>
        <div id="cards" class="mt-2"></div>
      </div>
    </div>
  </div>
</div>

<div class="sticky py-2">
  <div class="container">
    <div class="row g-2">
      <div class="col-6"><button id="gen" class="btn btn-cy w-100">âš¡ Generieren</button></div>
      <div class="col-6"><button id="gotoAna" class="btn btn-outline-light w-100">ðŸ“ˆ Analysieren</button></div>
    </div>
  </div>
</div>

<div class="overlay" id="ov"><div class="holo">KOMPLEXâ€‘ANALYSE</div></div>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a;}
function uniqueSorted(a){return Array.from(new Set(a)).sort((x,y)=>x-y);}
function iso(y,m,d){const dt=new Date(+y,+m-1,+d);return isNaN(dt)?null:dt.toISOString().slice(0,10);}

const LS_ARCH='ej_arch_cy', LS_RAW='ej_raw_cy';
let draws=[], freqM=Array(51).fill(0), freqE=Array(13).fill(0), lastM=Array(51).fill(null), lastE=Array(13).fill(null);
let generated=[], lastTip=null;

for(let i=1;i<=25;i++){const o=document.createElement('option');o.value=i;o.textContent=i;$('#n').appendChild(o);}
const GROUPS=[['1â€“10',1,10,'g1'],['11â€“20',11,20,'g2'],['21â€“30',21,30,'g3'],['31â€“40',31,40,'g4'],['41â€“50',41,50,'g5']];
const EG=[['1â€“6',1,6,'ge1'],['7â€“12',7,12,'ge2']];
function buildMap(){
  const m=$('#mwrap'); m.innerHTML='';
  GROUPS.forEach((g,ix)=>{
    const d=document.createElement('div'); d.className='band';
    d.innerHTML=`<div class="grad ${g[3]}"></div>`;
    const r=document.createElement('div');
    for(let n=g[1];n<=g[2];n++){ const c=document.createElement('div'); c.className='chip'; c.dataset.num=n; c.textContent=n; r.appendChild(c); }
    d.appendChild(r); m.appendChild(d);
  });
  const e=$('#ewrap'); e.innerHTML='';
  EG.forEach(g=>{
    const d=document.createElement('div'); d.className='band';
    d.innerHTML=`<div class="grad ${g[3]}"></div>`;
    const r=document.createElement('div');
    for(let n=g[1];n<=g[2];n++){ const c=document.createElement('div'); c.className='chip e'; c.dataset.enum=n; c.textContent=n; r.appendChild(c); }
    d.appendChild(r); e.appendChild(d);
  });
}
buildMap();

function buildGroupCtrls(){
  const host=$('#gCtrls'); host.innerHTML='';
  GROUPS.forEach((g,i)=>{
    const row=document.createElement('div'); row.className='d-flex align-items-center justify-content-between mb-1';
    row.innerHTML=`<div class="fw-bold">${g[0]}</div>`;
    const sel=document.createElement('select'); sel.className='form-select form-select-sm'; sel.style.width='80px';
    for(let v=0;v<=5;v++){const o=document.createElement('option');o.value=v;o.textContent=v;sel.appendChild(o);}
    sel.onchange=updateGroupCounter;
    row.appendChild(sel); host.appendChild(row);
  });
  const eh=$('#eCtrls'); eh.innerHTML='';
  EG.forEach((g,i)=>{
    const row=document.createElement('div'); row.className='d-flex align-items-center justify-content-between mb-1';
    row.innerHTML=`<div class="fw-bold">${g[0]}</div>`;
    const sel=document.createElement('select'); sel.className='form-select form-select-sm'; sel.style.width='80px';
    for(let v=0;v<=2;v++){const o=document.createElement('option');o.value=v;o.textContent=v;sel.appendChild(o);}
    sel.onchange=updateEuroCounter;
    row.appendChild(sel); eh.appendChild(row);
  });
}
buildGroupCtrls();
function updateGroupCounter(){const s=$$('#gCtrls select').reduce((a,x)=>a+ +x.value,0);$('#gc').textContent=s+'/â‰¤5';}
function updateEuroCounter(){const s=$$('#eCtrls select').reduce((a,x)=>a+ +x.value,0);$('#gcE').textContent=s+'/2';}

$('#mode').addEventListener('change',()=>{
  const on=$('#mode').value==='groups';
  $('#groups').style.display=on?'block':'none';
  $('#note').style.display=on?'none':'block';
});
$('#euroOn').addEventListener('change',()=>{$('#eCtrls').style.display=$('#euroOn').checked?'block':'none';});

/* ======= Dropzone (lokale Datei) ======= */
const dz=$('#drop');
;['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();dz.classList.add('drag');}));
;['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();dz.classList.remove('drag');}));
dz.addEventListener('drop',e=>{ const f=e.dataTransfer.files?.[0]; if(f) handleFile(f); });
$('#file').addEventListener('change',e=>{ const f=e.target.files?.[0]; if(f) handleFile(f); });

async function handleFile(f){
  try{
    $('#ast').textContent='Lese Dateiâ€¦';
    let txt='';
    if(f.name.toLowerCase().endsWith('.zip')){
      const zip=await JSZip.loadAsync(f);
      const entry=Object.values(zip.files).find(x=>/\.(txt|csv)$/i.test(x.name));
      if(!entry) throw new Error('Keine TXT/CSV in ZIP');
      txt=await entry.async('string');
    } else {
      txt=await f.text();
    }
    parseArchive(txt,true);
  }catch(err){
    $('#ast').textContent='Fehler beim Lesen: '+err.message;
  }
}

/* ======= Archiv Parser ======= */
function parseArchive(txt, save){
  window.__raw = txt;
  const lines = txt.replace(/\r\n?/g,'\n').split('\n').map(l=>l.trim()).filter(Boolean);
  const regDMY=/^(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})$/; const regYMD=/^(\d{4})[.\-/](\d{1,2})[.\-/](\d{1,2})$/;
  function parseLine(line){
    const t=line.split(/;|,|\t|\s+/).filter(Boolean); let date=null,rest=[];
    if(t[0]){
      if(regDMY.test(t[0])){const m=t[0].match(regDMY); date=iso(m[3],m[2],m[1]); rest=t.slice(1);}
      else if(regYMD.test(t[0])){const m=t[0].match(regYMD); date=iso(m[1],m[2],m[3]); rest=t.slice(1);}
      else rest=t.slice();
    }
    const nums=rest.map(Number).filter(n=>!Number.isNaN(n));
    const main=nums.filter(n=>n>=1&&n<=50).slice(0,5).sort((a,b)=>a-b);
    const euro=nums.filter(n=>n>=1&&n<=12).slice(0,2).sort((a,b)=>a-b);
    if(!date||main.length!==5||euro.length!==2) return null;
    return {date,main,euro};
  }
  draws=[]; freqM.fill(0); freqE.fill(0); lastM.fill(null); lastE.fill(null);
  for(const l of lines){const r=parseLine(l); if(r) draws.push(r);}
  draws.sort((a,b)=>a.date.localeCompare(b.date));
  draws.forEach((d,i)=>{ d.main.forEach(n=>{freqM[n]++; lastM[n]=i}); d.euro.forEach(n=>{freqE[n]++; lastE[n]=i}); });
  updateKPIs();
  $('#ast').textContent='Archiv geladen âœ”';
  if(save){ localStorage.setItem(LS_ARCH, JSON.stringify({draws,freqM,freqE,lastM,lastE})); localStorage.setItem(LS_RAW, txt); }
}
function updateKPIs(){
  if(!draws.length){ $('#kCount').textContent='â€“';$('#kFrom').textContent='â€“';$('#kTo').textContent='â€“';$('#kFresh').textContent='â€“'; return; }
  $('#kCount').textContent=draws.length;
  $('#kFrom').textContent=draws[0].date;
  $('#kTo').textContent=draws.at(-1).date;
  const dd=Math.round((Date.now()-new Date(draws.at(-1).date))/86400000);
  $('#kFresh').textContent=dd<=14?'ja':'alt';
}

/* ======= Generator ======= */
function pickRange(from,to,avoid,count,weight){
  const bag=[]; for(let n=from;n<=to;n++){ if(!avoid.includes(n)){ let w=weight?weight(n):1; w=Math.max(1,Math.floor(w)); for(let k=0;k<w;k++) bag.push(n);} }
  shuffle(bag); const res=[];
  for(const v of bag){ if(!res.includes(v)){ res.push(v); if(res.length===count) break; } }
  return res;
}
function euroAuto(){
  if(!draws.length){ return [1,2]; }
  const lastIdx=draws.length-1;
  const w = (e)=>{
    const f = freqE[e]/Math.max(1,Math.max(...freqE.slice(1)));
    const gap = lastE[e]==null ? lastIdx+1 : (lastIdx-lastE[e]);
    const gn = Math.min(1, gap/(lastIdx+1));
    return 1 + Math.round(3*(0.55*f + 0.45*gn));
  };
  let e = pickRange(1,12,[],2,w);
  if(e.length<2){
    const pool=Array.from({length:12},(_,i)=>i+1).filter(x=>!e.includes(x)); shuffle(pool);
    while(e.length<2 && pool.length) e.push(pool.pop());
  }
  return e.sort((a,b)=>a-b);
}
function ensureFive(main, weight=null){
  let m = uniqueSorted(main).slice(0,5);
  while(m.length<5){
    const add = pickRange(1,50,m,1,weight);
    if(add.length) m = uniqueSorted(m.concat(add));
    else{
      const pool=Array.from({length:50},(_,i)=>i+1).filter(x=>!m.includes(x)); shuffle(pool);
      while(m.length<5 && pool.length) m.push(pool.pop());
      m=uniqueSorted(m);
    }
  }
  return m.slice(0,5);
}
function genOne(){
  const mode=$('#mode').value;
  const recent = draws.slice(-100);
  const fm = Array(51).fill(1); recent.forEach(d=>d.main.forEach(n=>fm[n]++));
  const maxM = Math.max(...fm.slice(1));
  const wRecent = n=> 1 + Math.floor(3*fm[n]/Math.max(1,maxM));

  if(mode==='groups'){
    const wish=$$('#gCtrls select').map(s=>+s.value||0);
    const sum=wish.reduce((a,b)=>a+b,0); if(sum>5) throw new Error('Gruppen-Summe > 5');
    let main=[];
    GROUPS.forEach((g,i)=>{ const need=wish[i]; if(need>0){ main=uniqueSorted(main.concat(pickRange(g[1],g[2],main,need,wRecent))); } });
    main = ensureFive(main, wRecent);
    let euro=[];
    if($('#euroOn').checked){
      const ec=$$('#eCtrls select').map(s=>+s.value||0); const es=ec.reduce((a,b)=>a+b,0);
      if(!(es===0||es===2)) throw new Error('Euro-Summe muss 0 oder 2 sein');
      if(es===2){ EG.forEach((g,i)=>{ const need=ec[i]; if(need>0){ euro=uniqueSorted(euro.concat(pickRange(g[1],g[2],euro,need))); } }); if(euro.length<2){ euro=euroAuto(); } }
    }else{ euro = euroAuto(); }
    return {main, euro};
  }
  if(mode==='never' && draws.length){ const w=n=> (freqM[n]===0?6:(freqM[n]<=5?3:1)); return {main:ensureFive([],w), euro:euroAuto()}; }
  if(mode==='last100' && draws.length){ return {main:ensureFive([],wRecent), euro:euroAuto()}; }
  if(mode==='hot' && draws.length){
    const recent=draws.slice(-200);
    const pairs=new Map(), triples=new Map();
    const inc=(m,k)=>m.set(k,(m.get(k)||0)+1);
    for(const d of recent){
      const m=[...d.main].sort((a,b)=>a-b);
      for(let i=0;i<m.length;i++) for(let j=i+1;j<m.length;j++) inc(pairs,`${m[i]}-${m[j]}`);
      for(let i=0;i<m.length;i++) for(let j=i+1;j<m.length;j++) for(let k=j+1;k<m.length;k++) inc(triples,`${m[i]}-${m[j]}-${m[k]}`);
    }
    const tp=[...pairs.entries()].sort((a,b)=>b[1]-a[1]).slice(0,40).map(e=>e[0].split('-').map(Number));
    const tt=[...triples.entries()].sort((a,b)=>b[1]-a[1]).slice(0,25).map(e=>e[0].split('-').map(Number));
    let base=[]; if(Math.random()<0.5 && tt.length) base=tt[Math.floor(Math.random()*tt.length)]; else if(tp.length) base=tp[Math.floor(Math.random()*tp.length)]; 
    return {main:ensureFive(base,wRecent), euro:euroAuto()};
  }
  if(mode==='runs' && draws.length){
    const runMap=new Map(); const inc=(k)=>runMap.set(k,(runMap.get(k)||0)+1);
    for(const d of draws){
      const m=[...d.main].sort((a,b)=>a-b); let seq=[m[0]];
      for(let i=1;i<m.length;i++){
        if(m[i]===m[i-1]+1) seq.push(m[i]); else{
          if(seq.length>=2){ for(let L=2;L<=Math.min(4,seq.length);L++) for(let s=0;s+L<=seq.length;s++) inc(seq.slice(s,s+L).join('-')); }
          seq=[m[i]];
        }
      }
      if(seq.length>=2){ for(let L=2;L<=Math.min(4,seq.length);L++) for(let s=0;s+L<=seq.length;s++) inc(seq.slice(s,s+L).join('-')); }
    }
    const lastIdx=draws.length-1, score=[];
    for(const [k,v] of runMap.entries()){
      const nums=k.split('-').map(Number);
      const minLast=Math.min(...nums.map(n=> lastM[n]==null?-1:lastM[n]));
      const gap=minLast<0? lastIdx+1 : (lastIdx-minLast);
      const fresh=1 + gap/(lastIdx+1);
      score.push([nums, v*fresh]);
    }
    score.sort((a,b)=>b[1]-a[1]);
    const base=score.length? score[Math.floor(Math.random()*Math.min(12,score.length))][0] : [];
    return {main:ensureFive(base, wRecent), euro:euroAuto()};
  }
  if(mode==='complex' && draws.length){
    $('#ov').style.display='flex';
    try{
      const fN=n=>freqM[n]/Math.max(1,Math.max(...freqM.slice(1)));
      const gN=n=>{const li=lastM[n]==null?-1:lastM[n]; return li<0?1:(draws.length-1-li)/draws.length;};
      const w=n=>1+Math.round(5*(0.6*gN(n)+0.4*fN(n)));
      let cur=ensureFive([],w), best=cur.slice();
      function score(set){
        let s=set.reduce((a,x)=>a+0.5*fN(x)+0.8*gN(x),0);
        const cnt=[0,0,0,0,0]; set.forEach(n=>cnt[Math.floor((n-1)/10)]++);
        const bal = cnt.reduce((a,c)=>a+Math.abs(c-1),0); s += Math.max(0,5-bal)/5;
        return s;
      }
      let cs=score(cur), bs=cs; const ITER=1200;
      for(let t=0;t<ITER;t++){
        const c=cur.slice(); const rm=Math.floor(Math.random()*c.length);
        const avoid=c.slice(); avoid.splice(rm,1);
        const add=pickRange(1,50,avoid,1,w); if(add.length) c[rm]=add[0];
        c.sort((a,b)=>a-b); const sc=score(c);
        if(sc>cs || Math.random()<Math.exp((sc-cs)/(0.12+1e-4))){ cur=c; cs=sc; if(sc>bs){best=c; bs=sc;} }
      }
      return {main:best, euro:euroAuto()};
    } finally {
      $('#ov').style.display='none';
    }
  }
  return {main:ensureFive([]), euro:euroAuto()};
}

function clearMap(){ $$('.chip').forEach(c=>{c.classList.remove('typing','done')}); }
async function typeOnMap(tip,i,total){
  clearMap();
  const delay=$('#mode').value==='complex'?160:100;
  for(const n of tip.main){ const el=document.querySelector(`.chip[data-num="${n}"]`); if(el){el.classList.add('typing'); await sleep(delay); el.classList.remove('typing'); el.classList.add('done');}}
  for(const n of tip.euro){ const el=document.querySelector(`.chip[data-enum="${n}"]`); if(el){el.classList.add('typing'); await sleep(delay); el.classList.remove('typing'); el.classList.add('done');}}
  $('#label').textContent = `#${i}/${total}`;
  $('#pbar').style.width = Math.round(i/total*100)+'%';
}

function formatTip(t){return t.main.join('-') + ' | E:' + t.euro.join('-');}
function addCard(idx, t){
  const c=document.createElement('div'); c.className='cardx';
  const nums=document.createElement('div');
  t.main.forEach(n=>{const d=document.createElement('span');d.className='chip';d.textContent=n;nums.appendChild(d);});
  const sep=document.createElement('span'); sep.className='chip e'; sep.textContent='E'; nums.appendChild(sep);
  t.euro.forEach(n=>{const d=document.createElement('span');d.className='chip e';d.textContent=n;nums.appendChild(d);});
  const head=document.createElement('div'); head.className='d-flex justify-content-between align-items-center';
  head.innerHTML=`<strong>#${idx}</strong>`; head.appendChild(nums); c.appendChild(head);
  $('#cards').appendChild(c);
}

$('#gen').addEventListener('click', async ()=>{
  if(!draws.length){ alert('Bitte zuerst Archiv laden (Button oben klicken und Datei hier ablegen).'); return; }
  const total=+$('#n').value||1; $('#cards').innerHTML=''; $('#live').textContent=''; $('#pbar').style.width='0%';
  generated=[]; lastTip=null;
  for(let i=1;i<=total;i++){
    const t=genOne(); t.main = ensureFive(t.main); t.euro = euroAuto();
    generated.push(t); lastTip=t;
    $('#live').textContent += '#'+i+': '+formatTip(t)+'\n';
    await typeOnMap(t,i,total);
    addCard(i,t);
  }
});

function analyse(t){
  const dist=Array(8).fill(0); let occ=0, idxs=[];
  for(let i=0;i<draws.length;i++){
    const d=draws[i];
    const eqMain = d.main.join(',')===t.main.join(',');
    if(eqMain) {occ++; idxs.push(i);}
    const ov = t.main.filter(x=>d.main.includes(x)).length + t.euro.filter(x=>d.euro.includes(x)).length;
    dist[ov]++;
  }
  const ov3 = dist.slice(3).reduce((a,b)=>a+b,0);
  const freqSum = t.main.reduce((s,n)=>s+freqM[n],0);
  const box=document.createElement('div'); box.className='cardx';
  const rows = dist.map((v,i)=>{
    const pct=((v/draws.length)*100).toFixed(1);
    const w=Math.round((v/Math.max(1,Math.max(...dist)))*100);
    return `<tr><td>${i}</td><td style="width:70%"><div class="progress-neon"><i style="width:${w}%"></i></div></td><td class="text-end">${v} <span class="text-secondary">(${pct}%)</span></td></tr>`;
  }).join('');
  const first = occ? draws[idxs[0]].date : 'â€“';
  const last  = occ? draws[idxs.at(-1)].date : 'â€“';
  let gap='â€“'; if(idxs.length>1){ let g=0; for(let i=1;i<idxs.length;i++) g+=idxs[i]-idxs[i-1]; gap=(g/(idxs.length-1)).toFixed(1); }
  box.innerHTML = `<div><strong>Analyse:</strong> ${formatTip(t)}</div>
  <div class="small text-secondary">Vorkommen (exakt): <b>${occ}</b> â€” Erstes: <b>${first}</b> â€” Letztes: <b>${last}</b> â€” Ã˜ Abstand: <b>${gap}</b> â€” Overlap â‰¥3: <b>${ov3}</b> â€” Frequenzsumme: <b>${freqSum}</b></div>
  <div class="table-responsive mt-2"><table class="table table-dark table-sm align-middle">
  <thead><tr><th>Treffer</th><th>Verteilung</th><th class="text-end">Anzahl</th></tr></thead><tbody>${rows}</tbody></table></div>`;
  $('#ana').prepend(box);
}
$('#analyseTip').addEventListener('click', ()=>{
  if(!draws.length){alert('Archiv fehlt');return;}
  const m=$('#wishM').value.trim().split(/\s+|,|;|-/).map(Number).filter(n=>n>=1&&n<=50);
  const e=$('#wishE').value.trim()? $('#wishE').value.trim().split(/\s+|,|;|-/).map(Number).filter(n=>n>=1&&n<=12):[];
  if(m.length!==5){alert('5 Hauptzahlen angeben');return;}
  if(!(e.length===0||e.length===2)){alert('Euro 0 oder 2');return;}
  analyse({main:uniqueSorted(m).slice(0,5), euro:uniqueSorted(e).slice(0,2)});
});
$('#fromLast').addEventListener('click',()=>{
  if(!lastTip){alert('Noch keine Variante');return;}
  $('#wishM').value=lastTip.main.join(' '); $('#wishE').value=lastTip.euro.join(' ');
  analyse(lastTip);
});
$('#analyseAll').addEventListener('click',()=>{
  if(!generated.length){alert('Keine Varianten');return;}
  $('#ana').innerHTML='';
  generated.forEach(t=>analyse(t));
});

(function(){
  const s=localStorage.getItem(LS_ARCH), raw=localStorage.getItem(LS_RAW);
  if(s){ const obj=JSON.parse(s); draws=obj.draws||[]; freqM=obj.freqM||freqM; freqE=obj.freqE||freqE; lastM=obj.lastM||lastM; lastE=obj.lastE||lastE; updateKPIs(); $('#ast').textContent='Archiv aus Speicher âœ”'; }
})();
</script>
</body>
</html>
