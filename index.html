<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Eurojackpot Tool â€“ Dark Group UI</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
  :root{
    --bg:#0f1420;
    --panel:#121a2a;
    --panel-2:#0f1726;
    --text:#e6f0ff;
    --muted:#9bb2d1;
    --brand:#25d366;
    --accent:#00e0ff;
    --chip:#1b2538;
    --chip-hover:#253149;
    --glow:#39ff90;

    --g1-grad:linear-gradient(90deg,#3b82f6 0%, #1e3a8a 100%);
    --g2-grad:linear-gradient(90deg,#22c55e 0%, #064e3b 100%);
    --g3-grad:linear-gradient(90deg,#a855f7 0%, #4c1d95 100%);
    --g4-grad:linear-gradient(90deg,#f59e0b 0%, #713f12 100%);
    --g5-grad:linear-gradient(90deg,#ef4444 0%, #7f1d1d 100%);

    --e1-grad:linear-gradient(90deg,#f1c40f 0%, #8a6d00 100%);
    --e2-grad:linear-gradient(90deg,#14b8a6 0%, #0f766e 100%);
  }
  html,body{background:var(--bg); color:var(--text);}
  .app-title{font-weight:800; letter-spacing:.3px;}
  .cardx{background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid rgba(255,255,255,.06); border-radius:18px; padding:16px; box-shadow:0 12px 30px rgba(0,0,0,.25);}
  .section-title{font-weight:800;}

  .band{background:rgba(255,255,255,.05); border-radius:14px; padding:12px; margin-bottom:14px; border:1px solid rgba(255,255,255,.06);}
  .band .head{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;}
  .pill{font-size:.8rem; padding:.15rem .6rem; border-radius:999px; border:1px solid rgba(255,255,255,.12); color:var(--muted);}
  .grad{height:10px; border-radius:999px; margin:6px 0 8px 0;}

  .chip{display:inline-flex; align-items:center; justify-content:center; min-width:38px; height:38px;
        border-radius:12px; background:var(--chip); margin:4px; font-weight:700; color:#cfe3ff;
        border:1px solid rgba(255,255,255,.08); transition:.12s ease; user-select:none;}
  .chip:hover{background:var(--chip-hover);}
  .chip.dim{opacity:.4; filter:saturate(.7) brightness(.9);}
  .chip.typing{box-shadow:0 0 0 2px #1fff72, 0 0 16px var(--glow); border-color:#1fff72;}
  .chip.done{box-shadow:0 0 0 2px #00e0ff; border-color:#00e0ff;}

  .sticky-bottom-bar{position:fixed; left:0; right:0; bottom:0; z-index:1000;
    background:rgba(18,26,42,.86); border-top:1px solid rgba(255,255,255,.06); backdrop-filter: blur(6px);}
  .sticky-bottom-bar .btn{height:54px; font-weight:800; letter-spacing:.2px;}

  .live-box{font-family:ui-monospace, Menlo, Consolas, monospace; background:#0a0f19;
            border:1px solid rgba(255,255,255,.06); color:#b8ffcc; border-radius:12px; padding:12px; height:220px; overflow:auto;}
  .kpi{font-weight:800; color:#fff;}
  .muted{color:var(--muted);}

  .range-row{display:grid; grid-template-columns: 150px 1fr 70px; gap:12px; align-items:center; margin-bottom:12px;}
  .counter-pill{padding:.2rem .6rem; border-radius:999px; font-weight:800;}
  .counter-ok{background:rgba(37,211,102,.12); color:#39ff90;}
  .counter-bad{background:rgba(239,68,68,.12); color:#ff8f8f;}

  .result-card{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px; margin-bottom:8px;}
  .result-card .nums .chip{height:34px; min-width:34px; border-radius:10px;}

  .btn-dark{background:#1f2937; border-color:#1f2937;}
  .btn-outline-dark{border-color:#374151; color:#d1e2ff;}
</style>
</head>
<body>
<div class="container py-3 pb-5">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="app-title h4 mb-0">Eurojackpot Tool</h1>
    <a class="btn btn-sm btn-outline-dark" href="https://www.lotto-bayern.de/static/gamebroker_2/de/download_files/archiv_eurojackpot.zip" target="_blank" rel="noopener">Neueste ZIP</a>
  </div>

  <div class="row g-3">
    <div class="col-lg-6">
      <div class="cardx">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="section-title mb-1">1) Archiv</div>
            <div id="statusText" class="small muted">Noch kein Archiv geladen.</div>
          </div>
          <input class="form-control form-control-sm" type="file" id="zipInput" accept=".zip,.txt,.csv">
        </div>
        <hr class="text-secondary">
        <div class="row text-center g-3">
          <div class="col-6 col-md-3">
            <div class="muted small">Ziehungen</div>
            <div id="kpiCount" class="kpi">â€“</div>
          </div>
          <div class="col-6 col-md-3">
            <div class="muted small">Von</div>
            <div id="kpiFrom" class="kpi">â€“</div>
          </div>
          <div class="col-6 col-md-3">
            <div class="muted small">Bis</div>
            <div id="kpiTo" class="kpi">â€“</div>
          </div>
          <div class="col-6 col-md-3">
            <div class="muted small">AktualitÃ¤t</div>
            <div id="kpiFresh" class="kpi">â€“</div>
          </div>
        </div>
      </div>

      <div class="cardx mt-3">
        <div class="section-title mb-2">2) Einstellungen</div>
        <div class="mb-3">
          <label class="form-label muted">Anzahl Kombinationen</label>
          <select id="kombis" class="form-select"></select>
        </div>
        <div class="mb-3">
          <label class="form-label muted">Modus</label>
          <select id="modus" class="form-select">
            <option value="never">Nur nie gezogene</option>
            <option value="last100">Letzte 100 â€“ Frequenzmuster</option>
            <option value="hot">Hot Paare/Triples</option>
            <option value="groups">5er-Gruppen (streng)</option>
          </select>
        </div>

        <!-- Gruppen nur im Modus 'groups' -->
        <div id="groupSection" class="hide">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="muted small">Gruppen-Summe muss 5 sein.</div>
            <div id="mainCounter" class="counter-pill counter-ok">0/5</div>
          </div>
          <div id="groupControls"></div>
        </div>

        <hr class="text-secondary">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="toggleEuro">
          <label class="form-check-label" for="toggleEuro">Eurozahlen berÃ¼cksichtigen (2 Zahlen)</label>
        </div>
        <div id="euroSection" class="hide mt-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="muted small">Euro-Summe muss 0 oder 2 sein.</div>
            <div id="euroCounter" class="counter-pill counter-ok">0/2</div>
          </div>
          <div id="euroControls"></div>
        </div>
      </div>

      <div class="cardx mt-3">
        <div class="section-title mb-2">5) Batch-Analyse (Topâ€‘N Ergebnisse â†” Archiv)</div>
        <div class="row g-2">
          <div class="col-4">
            <label class="form-label muted small">Topâ€‘N</label>
            <input id="topN" type="number" min="1" max="50" value="5" class="form-control">
          </div>
          <div class="col-4">
            <label class="form-label muted small">Schwelle A (â‰¥)</label>
            <input id="thrA" type="number" min="1" max="7" value="4" class="form-control">
          </div>
          <div class="col-4">
            <label class="form-label muted small">Schwelle B (â‰¥)</label>
            <input id="thrB" type="number" min="1" max="7" value="5" class="form-control">
          </div>
        </div>
        <div class="mt-2 d-flex gap-2 flex-wrap">
          <button id="batchBtn" class="btn btn-success">Batch analysieren</button>
          <button id="csvBtn" class="btn btn-outline-success">CSV Export</button>
        </div>
        <div id="batchTable" class="mt-3 small"></div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="cardx">
        <div class="section-title mb-2">3) Map (1â€“50)</div>

        <!-- BÃ¤nder 1â€“10 ... 41â€“50 -->
        <div id="bandsMain"></div>

        <div class="section-title mt-3">Eurozahlen (1â€“12)</div>
        <div id="bandsEuro"></div>
      </div>

      <div class="cardx mt-3" id="resultsSection">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="section-title mb-0">4) Generieren</div>
          <div class="muted small" id="progressText">â€“</div>
        </div>
        <div id="liveOutput" class="live-box"></div>
        <div id="cards" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- Sticky bottom bar -->
<div class="sticky-bottom-bar py-2">
  <div class="container">
    <div class="row g-2">
      <div class="col-6">
        <button id="generateBtn" class="btn btn-dark w-100">âš¡ Generieren</button>
      </div>
      <div class="col-6">
        <button id="analyseBtn" class="btn btn-outline-dark w-100">ðŸ“ˆ Analysieren</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ------------ Helpers ------------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function smoothScrollTo(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
function iso(y,m,d){ const dt=new Date(+y, +m-1, +d); return isNaN(dt)? null : dt.toISOString().slice(0,10); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

/* ------------ State ------------- */
let draws=[];  // {date:'YYYY-MM-DD', main:[5], euro:[2]}
let freqMain = Array(51).fill(0);
let freqEuro = Array(13).fill(0);
let generated = []; // gespeicherte Tipps

/* ------------ UI build ------------- */
// Kombis 1..25
for(let i=1;i<=25;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; $('#kombis').appendChild(o); }

const GROUPS=[
  {label:'1â€“10', from:1, to:10, grad:'var(--g1-grad)'},
  {label:'11â€“20', from:11, to:20, grad:'var(--g2-grad)'},
  {label:'21â€“30', from:21, to:30, grad:'var(--g3-grad)'},
  {label:'31â€“40', from:31, to:40, grad:'var(--g4-grad)'},
  {label:'41â€“50', from:41, to:50, grad:'var(--g5-grad)'},
];
const EGROUPS=[
  {label:'1â€“6', from:1, to:6, grad:'var(--e1-grad)'},
  {label:'7â€“12', from:7, to:12, grad:'var(--e2-grad)'},
];

function buildBands(container, groups, startNum){
  container.innerHTML='';
  groups.forEach(g=>{
    const wrap=document.createElement('div'); wrap.className='band';
    const head=document.createElement('div'); head.className='head';
    head.innerHTML = `<div class="fw-bold">${g.label}</div><span class="pill">GESCHLOSSEN</span>`;
    const grad=document.createElement('div'); grad.className='grad'; grad.style.background=g.grad;
    const row=document.createElement('div');
    for(let n=g.from;n<=g.to;n++){
      const chip=document.createElement('div');
      chip.className='chip'; chip.textContent=n; chip.dataset.num=n;
      row.appendChild(chip);
    }
    wrap.appendChild(head); wrap.appendChild(grad); wrap.appendChild(row);
    container.appendChild(wrap);
  });
}
buildBands($('#bandsMain'), GROUPS);
buildBands($('#bandsEuro'), EGROUPS);

/* ------------ Group controls ------------- */
function buildGroupControls(){
  const host = $('#groupControls'); host.innerHTML='';
  GROUPS.forEach((g,idx)=>{
    const row=document.createElement('div'); row.className='range-row';
    const lab=document.createElement('div'); lab.innerHTML = `<div class="fw-bold">${g.label}</div>`;
    const sel=document.createElement('select'); sel.className='form-select'; sel.dataset.idx=idx;
    for(let v=0;v<=5;v++){ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }
    sel.addEventListener('change', updateCounters);
    const hint=document.createElement('div'); hint.className='text-end muted'; hint.textContent='0';
    row.appendChild(lab); row.appendChild(sel); row.appendChild(hint); host.appendChild(row);
  });
}
function buildEuroControls(){
  const host = $('#euroControls'); host.innerHTML='';
  EGROUPS.forEach((g,idx)=>{
    const row=document.createElement('div'); row.className='range-row';
    const lab=document.createElement('div'); lab.innerHTML = `<div class="fw-bold">${g.label}</div>`;
    const sel=document.createElement('select'); sel.className='form-select euro-sel'; sel.dataset.idx=idx;
    for(let v=0;v<=2;v++){ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }
    sel.addEventListener('change', updateCounters);
    const hint=document.createElement('div'); hint.className='text-end muted'; hint.textContent='0';
    row.appendChild(lab); row.appendChild(sel); row.appendChild(hint); host.appendChild(row);
  });
}
buildGroupControls(); buildEuroControls();

// Moduswechsel â†’ Gruppen-UI ein/aus
$('#modus').addEventListener('change', ()=>{
  const groupsMode = $('#modus').value === 'groups';
  $('#groupSection').classList.toggle('hide', !groupsMode);
  updateCounters();
});
// Euro-Toggle â†’ Euro-UI ein/aus
$('#toggleEuro').addEventListener('change', e=>{
  $('#euroSection').classList.toggle('hide', !e.target.checked);
  updateCounters();
});

function updateCounters(){
  const groupsMode = $('#modus').value === 'groups';
  let sum=0;
  if(groupsMode){
    $$('#groupControls select').forEach(sel=>{ const v=+sel.value||0; sum+=v; sel.parentElement.lastChild.textContent=v; });
    const mc=$('#mainCounter'); mc.textContent = sum+'/5'; mc.className='counter-pill '+(sum===5?'counter-ok':'counter-bad');
  }
  let esum=0;
  if($('#toggleEuro').checked){
    $$('#euroControls select').forEach(sel=>{ const v=+sel.value||0; esum+=v; sel.parentElement.lastChild.textContent=v; });
  }
  const ec = $('#euroCounter'); if(ec){ ec.textContent = esum+'/2'; ec.className='counter-pill '+((esum===0||esum===2)?'counter-ok':'counter-bad'); }
}
updateCounters();

/* ------------ Archiv Laden & Parsing ------------- */
document.getElementById('zipInput').addEventListener('change', handleFile);

async function handleFile(evt){
  const file = evt.target.files?.[0]; if(!file) return;
  resetArchiveUI();
  $('#statusText').textContent = 'Ladeâ€¦';
  try{
    let text = '';
    if(file.name.toLowerCase().endsWith('.zip')){
      const zip = await JSZip.loadAsync(file);
      const entries = Object.values(zip.files);
      let entry = entries.find(f=>/\.(txt|csv)$/i.test(f.name) && /eurojackpot/i.test(f.name)) ||
                  entries.find(f=>/\.(txt|csv)$/i.test(f.name));
      if(!entry) throw new Error('ZIP ohne lesbare TXT/CSV.');
      text = await entry.async('string');
    }else{
      text = await file.text();
    }
    parseArchiveText(text);
  }catch(e){
    console.error(e);
    $('#statusText').textContent = 'Fehler: '+e.message;
  }
}

function resetArchiveUI(){
  draws=[]; freqMain.fill(0); freqEuro.fill(0); generated=[];
  $('#kpiCount').textContent='â€“'; $('#kpiFrom').textContent='â€“'; $('#kpiTo').textContent='â€“'; $('#kpiFresh').textContent='â€“';
}

function parseArchiveText(txt){
  txt = txt.replace(/^\uFEFF/, '');
  const lines = txt.replace(/\r\n?/g,'\n').split('\n').map(l=>l.trim()).filter(l=>l.length>0);
  if(!lines.length){ $('#statusText').textContent='Leere Datei.'; return; }

  const regDMY = /^(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})$/;
  const regYMD = /^(\d{4})[.\-/](\d{1,2})[.\-/](\d{1,2})$/;

  function parseLine(line){
    const tokens = line.split(/;|,|\t|\s+/).filter(Boolean);
    let date=null, rest=[];

    if(tokens.length>=1){
      if(regDMY.test(tokens[0])){ const m=tokens[0].match(regDMY); date=iso(m[3],m[2],m[1]); rest=tokens.slice(1); }
      else if(regYMD.test(tokens[0])){ const m=tokens[0].match(regYMD); date=iso(m[1],m[2],m[3]); rest=tokens.slice(1); }
      else if(tokens.length>=3 && /^\d+$/.test(tokens[0]) && /^\d+$/.test(tokens[1]) && /^\d+$/.test(tokens[2])){
        date = iso(tokens[2], tokens[1], tokens[0]); rest = tokens.slice(3);
      }else{ rest = tokens.slice(); }
    }
    const nums = rest.map(Number).filter(n=>!Number.isNaN(n));
    if(!date && nums.length>=3){ const [a,b,c]=nums; const t=iso(c,b,a); if(t) date=t; }
    const main = nums.filter(n=>n>=1&&n<=50).slice(0,5).sort((a,b)=>a-b);
    const euro = nums.filter(n=>n>=1&&n<=12).slice(0,2).sort((a,b)=>a-b);
    if(!date || main.length!==5 || euro.length!==2) return null;
    return {date, main, euro};
  }

  for(const l of lines){
    const rec = parseLine(l);
    if(rec){ draws.push(rec); rec.main.forEach(n=>freqMain[n]++); rec.euro.forEach(n=>freqEuro[n]++); }
  }

  if(!draws.length){ $('#statusText').textContent='Keine gÃ¼ltigen Ziehungen erkannt.'; return; }
  draws.sort((a,b)=> a.date.localeCompare(b.date));
  $('#kpiCount').textContent = String(draws.length);
  $('#kpiFrom').textContent  = draws[0].date;
  $('#kpiTo').textContent    = draws[draws.length-1].date;
  const last = new Date(draws[draws.length-1].date);
  const deltaDays = Math.round((Date.now()-last.getTime())/86400000);
  $('#kpiFresh').textContent = (deltaDays<=14)? 'aktuell' : 'veraltet';
  $('#statusText').textContent = 'Archiv geladen âœ”';
}

/* ------------ Generator ------------- */
function pickFromRange(from,to,count,weightFn){
  const bag=[]; for(let n=from;n<=to;n++){ const w=Math.max(1, weightFn?weightFn(n):1); for(let k=0;k<w;k++) bag.push(n); }
  shuffle(bag);
  const res=[]; for(const v of bag){ if(!res.includes(v)){ res.push(v); if(res.length===count) break; } }
  return res;
}

function generateOne(){
  const mode = $('#modus').value;
  let main=[];
  if(mode==='groups'){
    const counts = $$('#groupControls select').map(s=>+s.value||0);
    const sum = counts.reduce((a,b)=>a+b,0);
    if(sum!==5) throw new Error('Gruppen-Summe muss 5 sein.');
    GROUPS.forEach((g,i)=>{ const need=counts[i]; if(need>0){ main.push(...pickFromRange(g.from,g.to,need,null)); } });
  }else{
    // Gewichte je nach Modus
    let weightMain=null;
    if(mode==='last100' && draws.length){
      const r=draws.slice(-100); const fm=Array(51).fill(1); r.forEach(d=>d.main.forEach(n=>fm[n]++));
      const maxM=Math.max(...fm.slice(1)); weightMain=n=>Math.ceil(3*fm[n]/maxM);
    }else if(mode==='never' && draws.length){
      const fm=freqMain.slice(); weightMain=n=> fm[n]===0?4:(fm[n]<=5?3:1);
    }else if(mode==='hot' && draws.length){
      const order=[...Array(51).keys()].slice(1).sort((a,b)=>freqMain[b]-freqMain[a]).slice(0,15);
      const pm=Array(51).fill(1); order.forEach(n=>pm[n]=3); weightMain=n=>pm[n];
    }
    main = pickFromRange(1,50,5,weightMain).sort((a,b)=>a-b);
  }

  // Euro optional
  let euro=[];
  if($('#toggleEuro').checked){
    const ecounts = $$('#euroControls select').map(s=>+s.value||0);
    const esum = ecounts.reduce((a,b)=>a+b,0);
    if(!(esum===0 || esum===2)) throw new Error('Euro-Summe muss 0 oder 2 sein.');
    if(esum===2){
      EGROUPS.forEach((g,i)=>{ const need=ecounts[i]; if(need>0){ euro.push(...pickFromRange(g.from,g.to,need,null)); } });
      euro.sort((a,b)=>a-b);
    }
  }
  return {main, euro};
}

function createResultCard(idx, tip){
  const card=document.createElement('div'); card.className='result-card d-flex align-items-center justify-content-between';
  const left=document.createElement('div'); left.innerHTML=`<div class="muted small">#${idx}</div>`;
  const nums=document.createElement('div'); nums.className='nums';
  [...tip.main].forEach(n=>{ const c=document.createElement('div'); c.className='chip'; c.textContent=n; nums.appendChild(c); });
  if(tip.euro.length){ const sep=document.createElement('span'); sep.className='muted small ms-2 me-1'; sep.textContent='|'; nums.appendChild(sep); tip.euro.forEach(n=>{ const c=document.createElement('div'); c.className='chip'; c.textContent='E'+n; nums.appendChild(c); }); }
  card.appendChild(left); card.appendChild(nums);
  return card;
}

async function liveType(tip, variantIndex){
  // dim alles
  $$('#bandsMain .chip, #bandsEuro .chip').forEach(c=>c.classList.add('dim'));
  const mark = (containerSel, nums)=>{
    nums.forEach(n=>{
      const el = document.querySelector(`${containerSel} .chip[data-num="${n}"]`);
      if(el){ el.classList.remove('dim'); el.classList.add('typing'); }
    });
  };
  // Schritt 1: Hauptzahlen tippen
  for(const n of tip.main){
    const el = document.querySelector(`#bandsMain .chip[data-num="${n}"]`);
    if(el){ el.classList.remove('dim'); el.classList.add('typing'); await sleep(120); }
  }
  // Schritt 2: Euro
  for(const n of tip.euro){
    const el = document.querySelector(`#bandsEuro .chip[data-num="${n}"]`);
    if(el){ el.classList.remove('dim'); el.classList.add('typing'); await sleep(120); }
  }
  // Done-Status
  $$('.typing').forEach(c=>{ c.classList.remove('typing'); c.classList.add('done'); });
  // VariantenzÃ¤hler
  $('#progressText').textContent = `Variante #${variantIndex}`;
}

/* ------------ Buttons ------------- */
document.getElementById('generateBtn').addEventListener('click', async ()=>{
  smoothScrollTo(document.getElementById('resultsSection'));
  const total = +document.getElementById('kombis').value || 1;
  const out = document.getElementById('liveOutput'); out.textContent='';
  const cards = document.getElementById('cards'); cards.innerHTML='';
  $('#progressText').textContent = 'Startâ€¦';
  generated = [];

  for(let i=1;i<=total;i++){
    try{
      const tip = generateOne();
      generated.push(tip);
      out.textContent += '#'+i+': '+ tip.main.join('-') + (tip.euro.length? ' | E:'+tip.euro.join('-'):'') + '\\n';
      await liveType(tip, i);
      cards.appendChild(createResultCard(i, tip));
      out.scrollTop = out.scrollHeight;
    }catch(e){
      out.textContent += 'FEHLER: '+e.message+'\\n';
      break;
    }
  }
});

document.getElementById('analyseBtn').addEventListener('click', ()=>{
  smoothScrollTo(document.getElementById('resultsSection'));
});

/* ------------ Batch-Analyse (einfach) ------------- */
document.getElementById('batchBtn').addEventListener('click', ()=>{
  if(!draws.length || !generated.length){ $('#batchTable').innerHTML='<div class="muted">Erst Archiv laden und Ergebnisse generieren.</div>'; return; }
  const topN = Math.max(1, Math.min(+$('#topN').value||5, generated.length));
  const thrA = +$('#thrA').value||4;
  const thrB = +$('#thrB').value||5;

  const rows = [];
  for(let i=0;i<topN;i++){
    const tip = generated[i];
    let maxOverlap=0, overA=0, overB=0, hits=0;
    for(const d of draws){
      const overlap = tip.main.filter(x=>d.main.includes(x)).length + tip.euro.filter(x=>d.euro.includes(x)).length;
      if(overlap>maxOverlap) maxOverlap=overlap;
      if(overlap>=thrA) overA++;
      if(overlap>=thrB) overB++;
      if(overlap===7) hits++;
    }
    rows.push({idx:i+1, tip, maxOverlap, overA, overB, hits});
  }

  let html = `<div class="table-responsive"><table class="table table-dark table-sm align-middle">
    <thead><tr><th>#</th><th>Kombi</th><th>Max Ãœberl.</th><th>Ãœberl. â‰¥${thrA}</th><th>Ãœberl. â‰¥${thrB}</th><th>Volltreffer</th></tr></thead><tbody>`;
  rows.forEach(r=>{
    const tipStr = r.tip.main.join('-') + (r.tip.euro.length? ' | E:'+r.tip.euro.join('-'):'');
    html += `<tr><td>${r.idx}</td><td>${tipStr}</td><td>${r.maxOverlap}</td><td>${r.overA}</td><td>${r.overB}</td><td>${r.hits}</td></tr>`;
  });
  html += '</tbody></table></div>';
  $('#batchTable').innerHTML = html;
});

document.getElementById('csvBtn').addEventListener('click', ()=>{
  if(!generated.length){ return; }
  const lines = generated.map((t,i)=> `${i+1};${t.main.join('-')};${t.euro.join('-')}`);
  const blob = new Blob(['#;Main;Euro\n', ...lines].join('\n'), {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='ergebnisse.csv'; a.click();
  URL.revokeObjectURL(url);
});

// Init visibility
document.getElementById('groupSection').classList.add('hide');
document.getElementById('euroSection').classList.add('hide');
</script>
</body>
</html>
