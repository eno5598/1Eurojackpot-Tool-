<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eurojackpot Tool by EnoWeb v6.4.3</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#0a0a0f; color:#eee; font-family:Inter, Arial, sans-serif; }
    h1 { background:linear-gradient(90deg,#00fff0,#ff00ea); -webkit-background-clip:text; color:transparent; font-weight:900; }
    .glass{background:rgba(15,18,40,.78); backdrop-filter: blur(14px); border:1px solid rgba(0,255,255,.18); border-radius:14px; padding:14px; box-shadow: 0 12px 40px rgba(0,0,0,.45);}
    .nav-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px; min-width:90px;height:78px;padding:8px 10px;border-radius:16px;background:linear-gradient(180deg,rgba(18,24,50,.9),rgba(14,18,36,.9)); border:1px solid rgba(255,255,255,.08); box-shadow: inset 0 0 0 1px rgba(255,255,255,.06), 0 8px 22px rgba(0,0,0,.4);}
    .nav-btn.active{outline:2px solid rgba(255,255,255,.15); box-shadow:0 0 20px rgba(0,255,255,.35), inset 0 0 0 1px rgba(255,255,255,.1);}
    .chip{display:inline-flex;align-items:center;justify-content:center;min-width:32px;height:32px;border-radius:10px;margin:4px;font-weight:800;font-size:.9rem;color:#bdfcff;background:linear-gradient(180deg,#0e1530,#15204a);border:1px solid rgba(0,255,255,.25);}
    .chip.euro{color:#ffe6ff;background:linear-gradient(180deg,#1c1433,#1c2b53);border-color:rgba(255,0,234,.3)}
    .chip.sel{background:linear-gradient(180deg,rgba(0,255,240,.25),rgba(0,255,240,.05)); box-shadow:0 0 16px rgba(0,255,240,.35), inset 0 0 0 1px rgba(0,255,255,.45); }
    .badge{background:rgba(255,255,255,.06); border:1px solid rgba(140,170,255,.22); border-radius:999px; padding:.15rem .5rem; font-size:.72rem;}
    .counter{padding:.2rem .55rem;border-radius:999px;font-weight:700}
    .counter.red{background:#3a1520;border:1px solid #ff6b94}
    .counter.green{background:#153a29;border:1px solid #39ff88}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;height:44px;padding:0 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);font-weight:700}
    .btn--green{background:#15803d;color:#fff;}
    .btn--amber{background:#b45309;color:#fff;}
    .btn--gray{background:#374151;color:#fff;}
    .btn:hover{filter:brightness(1.1)}
  </style>
</head>
<body class="p-5">
  <h1 class="text-3xl md:text-4xl mb-4">Eurojackpot Tool by EnoWeb</h1>

  <!-- NAV -->
  <div class="flex justify-center flex-wrap gap-3 mb-6">
    <button type="button" onclick="tab('archiv', this)" class="nav-btn active" id="btn-archiv"><div>📂</div><span>Archiv</span></button>
    <button type="button" onclick="tab('map', this)" class="nav-btn" id="btn-map"><div>🗺️</div><span>Map</span></button>
    <button type="button" onclick="tab('gen', this)" class="nav-btn" id="btn-gen"><div>⚡</div><span>Generieren</span></button>
    <button type="button" onclick="tab('ana', this)" class="nav-btn" id="btn-ana"><div>📊</div><span>Analyse</span></button>
    <button type="button" onclick="tab('fav', this)" class="nav-btn" id="btn-fav"><div>⭐</div><span>Favoriten</span></button>
  </div>

  <!-- ARCHIV -->
  <div id="v-archiv" class="glass">
    <h2 class="text-xl font-bold mb-2">📂 Archiv</h2>
    <p id="statusText" class="text-sm mb-2">Noch kein Archiv geladen.</p>

    <div class="glass mb-3">
      <div class="font-semibold mb-2">Automatisches Laden</div>
      <div class="flex flex-col md:flex-row gap-2">
        <input id="archiveUrl" class="bg-gray-900 p-2 rounded flex-1" value="https://www.lotto-bayern.de/static/gamebroker_2/de/download_files/archiv_eurojackpot.zip">
        <button type="button" id="loadLatestBtn" class="btn btn--green">📥 Neueste laden</button>
        <button type="button" id="forceDlBtn" class="btn btn--amber">⬇️ ZIP speichern</button>
        <a id="directDl" class="btn btn--gray" target="_blank" rel="noopener">🔗 Direktlink</a>
      </div>
      <p class="text-xs text-gray-300 mt-2">„ZIP speichern“ lädt über Proxy und speichert lokal (umgeht CORS). „Direktlink“ öffnet die Original-URL.</p>
    </div>

    <div class="glass mb-3">
      <div class="font-semibold mb-2">Manuell laden</div>
      <label class="btn btn--gray">
        📄 Datei auswählen
        <input type="file" id="zipInput" style="display:none" accept=".zip,.txt,.csv">
      </label>
      <span id="fileName" class="ml-2 text-sm opacity-80">Keine Datei ausgewählt</span>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center">
      <div><div class="text-sm text-gray-300">Ziehungen</div><div id="kpiCount" class="font-bold">–</div></div>
      <div><div class="text-sm text-gray-300">Von</div><div id="kpiFrom" class="font-bold">–</div></div>
      <div><div class="text-sm text-gray-300">Bis</div><div id="kpiTo" class="font-bold">–</div></div>
      <div><div class="text-sm text-gray-300">Aktualität</div><div id="kpiFresh" class="font-bold">–</div></div>
    </div>
  </div>

  <!-- MAP -->
  <div id="v-map" class="glass hidden">
    <div class="flex items-center justify-between mb-1">
      <h2 class="text-xl font-bold">🗺 Map</h2>
      <div class="badge">Live‑Animation</div>
    </div>
    <div class="mb-1 flex items-center justify-between">
      <div class="badge">Hauptzahlen 1–50</div><div id="progress" class="badge">Bereit</div>
    </div>
    <div id="mapMain" class="flex flex-wrap relative"></div>
    <div class="mt-3 badge">Eurozahlen 1–12</div>
    <div id="mapEuro" class="flex flex-wrap relative"></div>
  </div>

  <!-- GENERIEREN -->
  <div id="v-gen" class="glass hidden">
    <h2 class="text-xl font-bold mb-2">⚡ Generieren</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <div>
        <label class="text-sm text-gray-300">Modus</label>
        <select id="modus" class="bg-gray-900 p-2 rounded w-full">
          <option value="runs">Folgen‑Zahlen</option>
          <option value="never">Nie gezogene</option>
          <option value="last100">Letzte 100 – Frequenzmuster</option>
          <option value="hot">Hot Paare & Triples</option>
          <option value="groups">5er-Gruppen + Wünsche</option>
          <option value="complex">Komplex (Simulated Annealing)</option>
        </select>
      </div>
      <div>
        <label class="text-sm text-gray-300">Anzahl Kombinationen</label>
        <input type="number" id="kombis" value="5" min="1" max="25" class="bg-gray-900 p-2 rounded w-full">
      </div>
      <div class="grid grid-cols-3 gap-2">
        <button type="button" id="generateBtn" class="btn btn--green">⚡ Generieren</button>
        <button type="button" id="analyseAllBtn" class="btn btn--amber">📊 Alle analysieren</button>
        <button type="button" id="clearGeneratedBtn" class="btn btn--gray">🗑️ Alle löschen</button>
      </div>
    </div>

    <div id="groupUI" class="mt-4 hidden">
      <div class="mb-1 text-sm text-gray-300 flex items-center gap-3">
        <span>Gruppen: exakt 5 erforderlich</span>
        <span id="mainCounter" class="counter red">0/5</span>
        <span id="euroCounter" class="counter red hidden">0/2</span>
      </div>
      <div id="groupControls" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div>
      <div class="mt-1 flex items-center justify-between">
        <div class="badge">Eurozahlen (optional, 0 oder 2)</div>
        <label class="inline-flex items-center gap-2">
          <input id="useEuro" type="checkbox"><span class="text-sm">Euro berücksichtigen</span>
        </label>
      </div>
      <div id="euroControls" class="grid grid-cols-2 gap-2 mt-1 hidden"></div>
      <div id="groupError" class="bg-red-900/40 border border-red-400 text-red-200 rounded px-2 py-1 hidden mt-2"></div>
    </div>

    <pre id="liveOutput" class="font-mono bg-black/70 p-3 mt-3 rounded h-44 overflow-auto text-green-300"></pre>
    <div id="cards" class="mt-3"></div>
  </div>

  <!-- ANALYSE -->
  <div id="v-ana" class="glass hidden">
    <h2 class="text-xl font-bold mb-2">📊 Analyse</h2>
    <canvas id="chartMain" class="w-full h-60 mb-4"></canvas>
    <canvas id="chartEuro" class="w-full h-56"></canvas>
    <div id="analysisBox" class="mt-3 text-sm"></div>
  </div>

  <!-- FAVORITEN -->
  <div id="v-fav" class="glass hidden">
    <h2 class="text-xl font-bold mb-2">⭐ Favoriten</h2>
    <div class="flex gap-2 flex-wrap mb-3">
      <input id="favSearch" placeholder="Suche…" class="bg-gray-900 p-2 rounded flex-1 min-w-[180px]">
      <button type="button" id="favExport" class="btn btn--gray">Export</button>
      <button type="button" id="favImport" class="btn btn--gray">Import</button>
      <button type="button" id="favCSV" class="btn btn--gray">CSV</button>
      <button type="button" id="favClear" class="btn btn--gray">Leeren</button>
    </div>
    <div id="favoritesBox" class="space-y-2"></div>
  </div>

<script>
/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const sum = a => a.reduce((s,v)=>s+v,0);

/* ===== Tabs ===== */
function tab(name, btn){
  ['archiv','map','gen','ana','fav'].forEach(n=>$('#v-'+n).classList.add('hidden'));
  $('#v-'+name).classList.remove('hidden');
  $$('.nav-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  if(name==='fav') renderFavs();
}

/* ===== Map ===== */
function renderMap(){
  const m=$('#mapMain'); m.innerHTML='';
  for(let i=1;i<=50;i++){ const d=document.createElement('div'); d.className='chip'; d.textContent=i; d.dataset.n=i; m.appendChild(d); }
  const e=$('#mapEuro'); e.innerHTML='';
  for(let i=1;i<=12;i++){ const d=document.createElement('div'); d.className='chip euro'; d.textContent=i; d.dataset.n=i; e.appendChild(d); }
  $('#progress').textContent='Bereit';
}
renderMap();
function clearMap(){ $$('#mapMain .chip, #mapEuro .chip').forEach(c=>c.classList.remove('sel')); }
async function animateSelection(main,euro){
  tab('map',$('#btn-map')); clearMap(); $('#progress').textContent='Tippt…';
  for(const n of main){ const el=$(`#mapMain .chip[data-n="${n}"]`); if(el){ el.classList.add('sel'); await sleep(150);} }
  for(const n of euro){ const el=$(`#mapEuro .chip[data-n="${n}"]`); if(el){ el.classList.add('sel'); await sleep(150);} }
  $('#progress').textContent='Fertig';
}

/* ===== State ===== */
let draws=[]; let freqMain=Array(51).fill(0), freqEuro=Array(13).fill(0); let lastSeen=Array(51).fill(null), lastSeenE=Array(13).fill(null);
let generated=[]; let favorites = JSON.parse(localStorage.getItem("ej_favs_v1")||"[]");
const ARCH_KEY='ej_archive_v1';

/* ===== KPIs ===== */
function setKPIs(){
  if(!draws.length){ $('#kpiCount').textContent='–'; $('#kpiFrom').textContent='–'; $('#kpiTo').textContent='–'; $('#kpiFresh').textContent='–'; return; }
  $('#kpiCount').textContent=draws.length;
  $('#kpiFrom').textContent=draws[0].date;
  $('#kpiTo').textContent=draws.at(-1).date;
  const last=new Date(draws.at(-1).date);
  const days=Math.max(0, Math.round((Date.now()-last.getTime())/86400000));
  let label=''; if(days<=14) label=`aktuell`; else if(days<=60) label=`ok (${days} Tage alt)`; else label=`veraltet (${days} Tage alt)`;
  $('#kpiFresh').textContent=label;
}

/* ===== Archiv: Download/Parse ===== */
async function fetchWithProxies(url){
  const trials=[url,'https://cors.isomorphic-git.org/'+url,'https://api.allorigins.win/raw?url='+encodeURIComponent(url)];
  let last=null;
  for(const u of trials){
    try{
      const res=await fetch(u);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const ct=res.headers.get('content-type')||'';
      if(ct.includes('zip') || u.endsWith('.zip')){
        const blob=await res.blob();
        const zip=await JSZip.loadAsync(blob); const entries=Object.values(zip.files);
        let entry=entries.find(f=>/\.(txt|csv)$/i.test(f.name) && /eurojackpot/i.test(f.name)) || entries.find(f=>/\.(txt|csv)$/i.test(f.name));
        if(!entry) throw new Error('ZIP ohne TXT/CSV.');
        const text=await entry.async('string'); return text;
      }else{ return await res.text(); }
    }catch(e){ last=e; }
  }
  throw last||new Error('Download fehlgeschlagen');
}
function parseArchiveText(txt){
  try{
    txt=txt.replace(/^\uFEFF/,'');
    const lines = txt.replace(/\r\n?/g,'\n').split('\n').map(l=>l.trim()).filter(Boolean);
    const cleaned = lines.filter(l => (l.match(/\d+/g)||[]).length >= 7);
    function iso(y,m,d){ const dt=new Date(+y, +m-1, +d); return isNaN(dt)? null : dt.toISOString().slice(0,10); }
    const regDMY=/(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})/; const regYMD=/(\d{4})[.\-\/](\d{1,2})[.\-\/](\d{1,2})/;
    function parseLine(line){
      const t=line.split(/;|,|\t|\s+/).filter(Boolean); let date=null,rest=[];
      if(t.length>=1){
        if(regDMY.test(t[0])){const m=t[0].match(regDMY); date=iso(m[3],m[2],m[1]); rest=t.slice(1);}
        else if(regYMD.test(t[0])){const m=t[0].match(regYMD); date=iso(m[1],m[2],m[3]); rest=t.slice(1);}
        else rest=t.slice(0);
      }
      const nums=rest.map(Number).filter(n=>!Number.isNaN(n));
      if(!date){
        const only=(line.match(/\d+/g)||[]).map(Number);
        if(only.length>=7){ const [a,b,c]=only.slice(0,3); const d=iso(c,b,a); if(d) date=d; }
      }
      const main=nums.filter(n=>n>=1&&n<=50).slice(0,5).sort((a,b)=>a-b);
      const euro=nums.filter(n=>n>=1&&n<=12).slice(0,2).sort((a,b)=>a-b);
      if(!date||main.length!==5||euro.length!==2) return null;
      return {date, main, euro};
    }
    draws=[]; freqMain.fill(0); freqEuro.fill(0); lastSeen.fill(null); lastSeenE.fill(null);
    cleaned.forEach(l=>{ const r=parseLine(l); if(r) draws.push(r); });
    if(!draws.length) throw new Error('Keine gültigen Ziehungen erkannt.');
    draws.sort((a,b)=>a.date.localeCompare(b.date));
    draws.forEach((d,idx)=>{ d.main.forEach(n=>{freqMain[n]++; lastSeen[n]=idx;}); d.euro.forEach(n=>{freqEuro[n]++; lastSeenE[n]=idx;}); });
    localStorage.setItem(ARCH_KEY, txt);
    $('#statusText').textContent='Archiv geladen ✔';
    setKPIs(); renderCharts(); renderAnalyseKPIs();
  }catch(e){ $('#statusText').textContent='Fehler: '+e.message; }
}
document.getElementById('loadLatestBtn').addEventListener('click', async ()=>{
  const url=$('#archiveUrl').value.trim();
  $('#statusText').textContent='Lade neuestes Archiv…';
  try{ const text=await fetchWithProxies(url); parseArchiveText(text); }
  catch(e){ $('#statusText').innerHTML="Download nicht möglich. <a class='underline' target='_blank' href='"+url+"'>Manuell öffnen</a>."; }
});
document.getElementById('forceDlBtn').addEventListener('click', async ()=>{
  const url=$('#archiveUrl').value.trim();
  const trials=['https://cors.isomorphic-git.org/'+url,'https://api.allorigins.win/raw?url='+encodeURIComponent(url),url];
  let last=null;
  for(const u of trials){
    try{
      const res=await fetch(u); if(!res.ok) throw new Error('HTTP '+res.status);
      const blob=await res.blob();
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='archiv_eurojackpot.zip'; a.click(); URL.revokeObjectURL(a.href);
      return;
    }catch(e){ last=e; }
  }
  alert('Direkt-Download nicht möglich: '+(last?.message||'Unbekannt'));
});
(function(){ const u=$('#archiveUrl').value.trim(); $('#directDl').href=u; })();

/* File input */
document.getElementById('zipInput').addEventListener('change', async (e)=>{
  const file=e.target.files?.[0]; if(!file) return; $('#fileName').textContent=file.name;
  try{
    let text='';
    if(file.name.toLowerCase().endsWith('.zip')){
      const zip=await JSZip.loadAsync(file); const entries=Object.values(zip.files);
      let entry=entries.find(f=>/\.(txt|csv)$/i.test(f.name) && /eurojackpot/i.test(f.name)) || entries.find(f=>/\.(txt|csv)$/i.test(f.name));
      if(!entry) throw new Error('ZIP ohne TXT/CSV.');
      text=await entry.async('string');
    }else{ text=await file.text(); }
    parseArchiveText(text);
  }catch(err){ $('#statusText').textContent='Fehler: '+err.message; }
});

/* ===== Analyse (Charts + KPIs) ===== */
let chartMain, chartEuro;
function renderCharts(){
  if(chartMain) chartMain.destroy(); if(chartEuro) chartEuro.destroy();
  chartMain=new Chart($('#chartMain'),{type:'bar',data:{labels:[...Array(50).keys()].slice(1),datasets:[{data:[...freqMain].slice(1), borderWidth:0}]},options:{plugins:{legend:{display:false}}}});
  chartEuro=new Chart($('#chartEuro'),{type:'bar',data:{labels:[...Array(12).keys()].slice(1),datasets:[{data:[...freqEuro].slice(1), borderWidth:0}]},options:{plugins:{legend:{display:false}}}});
}
function renderAnalyseKPIs(){
  if(!draws.length) return;
  const mf = [...freqMain].map((v,i)=>[i,v]).slice(1).sort((a,b)=>b[1]-a[1]);
  const lf = [...freqMain].map((v,i)=>[i,v]).slice(1).sort((a,b)=>a[1]-b[1]);
  const top = mf.slice(0,5).map(x=>x[0]).join(' ');
  const low = lf.slice(0,5).map(x=>x[0]).join(' ');
  // Platz für zusätzliche KPI Felder (optional)
}

/* ===== Gruppen UI ===== */
const GROUPS=[{label:'1–10',from:1,to:10},{label:'11–20',from:11,to:20},{label:'21–30',from:21,to:30},{label:'31–40',from:31,to:40},{label:'41–50',from:41,to:50}];
const EGROUPS=[{label:'1–6',from:1,to:6},{label:'7–12',from:7,to:12}];
function buildGroupUI(){
  const host=$('#groupControls'); host.innerHTML='';
  GROUPS.forEach((g,i)=>{
    const row=document.createElement('div'); row.className='grid grid-cols-3 gap-2 items-center';
    row.innerHTML=\`<div class="font-bold">\${g.label}</div><select class="bg-gray-900 p-2 rounded" data-idx="\${i}">\${[0,1,2,3,4,5].map(v=>\`<option value="\${v}">\${v}</option>\`).join('')}</select><div class="text-right text-sm text-gray-400">0</div>\`;
    host.appendChild(row);
  });
  $$('#groupControls select').forEach(sel=> sel.addEventListener('change', updateCounters));
  updateCounters();
}
function buildEuroUI(){
  const host=$('#euroControls'); host.innerHTML='';
  EGROUPS.forEach((g,i)=>{
    const row=document.createElement('div'); row.className='grid grid-cols-3 gap-2 items-center';
    row.innerHTML=\`<div class="font-bold">\${g.label}</div><select class="bg-gray-900 p-2 rounded euro" data-idx="\${i}">\${[0,1,2].map(v=>\`<option value="\${v}">\${v}</option>\`).join('')}</select><div class="text-right text-sm text-gray-400">0</div>\`;
    host.appendChild(row);
  });
  $$('#euroControls select').forEach(sel=> sel.addEventListener('change', updateCounters));
}
function setCounter(el, val, total){ el.textContent=\`\${val}/\${total}\`; el.classList.toggle('green', val===total); el.classList.toggle('red', val!==total); }
function updateCounters(){
  let sumG=0; $$('#groupControls select').forEach(s=>{ const v=+s.value||0; sumG+=v; s.parentElement.lastChild.textContent=v; });
  setCounter($('#mainCounter'), sumG, 5);
  let sumE=0;
  if($('#useEuro').checked){ $$('#euroControls select').forEach(s=>{ const v=+s.value||0; sumE+=v; s.parentElement.lastChild.textContent=v; }); $('#euroCounter').classList.remove('hidden'); setCounter($('#euroCounter'), sumE, 2); } else { $('#euroCounter').classList.add('hidden'); }
  const err=$('#groupError'); err.classList.add('hidden'); err.textContent='';
  if(sumG!==5){ err.classList.remove('hidden'); err.textContent='Bitte genau 5 aus den Gruppen wählen.'; }
  if($('#useEuro').checked && !(sumE===0 || sumE===2)){ err.classList.remove('hidden'); err.textContent='Euro-Summe muss 0 oder 2 sein.'; }
}
$('#modus').addEventListener('change', ()=>{ const on=$('#modus').value==='groups'; $('#groupUI').classList.toggle('hidden', !on); if(on){ buildGroupUI(); }});
$('#useEuro').addEventListener('change', e=>{ $('#euroControls').classList.toggle('hidden', !e.target.checked); if(e.target.checked){ buildEuroUI(); setCounter($('#euroCounter'),0,2);} updateCounters(); });

/* ===== Generation ===== */
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function pick(from,to,avoid,count,weight){ const bag=[]; for(let n=from;n<=to;n++){ if(!avoid.includes(n)){ const w=Math.max(1, weight?weight(n):1); for(let k=0;k<w;k++) bag.push(n);} } shuffle(bag); const out=[]; for(const v of bag){ if(!out.includes(v)){ out.push(v); if(out.length===count) break; } } return out; }
function euroAuto(){ return pick(1,12,[],2).sort((a,b)=>a-b); }
function generateOne(){
  const mode=$('#modus').value; let main=[];
  if(!draws.length){ main=pick(1,50,[],5).sort((a,b)=>a-b); return {main, euro: pick(1,12,[],2).sort((a,b)=>a-b)}; }
  if(mode==='never'){ main=pick(1,50,[],5, n=> (freqMain[n]===0?5:(freqMain[n]<=5?3:1))).sort((a,b)=>a-b); return {main, euro:euroAuto()}; }
  if(mode==='last100'){ const r=draws.slice(-100); const fm=Array(51).fill(1); r.forEach(d=>d.main.forEach(n=>fm[n]++)); const max=Math.max(...fm.slice(1)); const w=n=>Math.ceil(3*fm[n]/max); main=pick(1,50,[],5,w).sort((a,b)=>a-b); return {main, euro:euroAuto()}; }
  if(mode==='runs'){ const map=new Map(); function inc(k){map.set(k,(map.get(k)||0)+1);} for(const d of draws){ const m=[...d.main].sort((a,b)=>a-b); let seq=[m[0]]; for(let i=1;i<m.length;i++){ if(m[i]===m[i-1]+1){ seq.push(m[i]); } else { if(seq.length>=2){ for(let L=2; L<=Math.min(4,seq.length); L++){ for(let s=0;s+L<=seq.length;s++){ inc(seq.slice(s,s+L).join('-')); } } } seq=[m[i]]; } } if(seq.length>=2){ for(let L=2; L<=Math.min(4,seq.length); L++){ for(let s=0;s+L<=seq.length;s++){ inc(seq.slice(s,s+L).join('-')); } } } } const entries=[...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,40); const base=entries.length? entries[Math.floor(Math.random()*entries.length)][0].split('-').map(Number):[]; main=Array.from(new Set(base)); while(main.length<5){ const add=pick(1,50,main,1, n=> (freqMain[n]?freqMain[n]:1)); if(add.length) main.push(add[0]); else break; } main=Array.from(new Set(main)).sort((a,b)=>a-b).slice(0,5); return {main, euro:euroAuto()}; }
  if(mode==='hot'){ const recent=draws.slice(-200); const pair=new Map(), triple=new Map(); function inc(m,k){m.set(k,(m.get(k)||0)+1);} for(const d of recent){ const m=[...d.main].sort((a,b)=>a-b); for(let i=0;i<m.length;i++) for(let j=i+1;j<m.length;j++) inc(pair, \`\${m[i]}-\${m[j]}\`); for(let i=0;i<m.length;i++) for(let j=i+1;j<m.length;j++) for(let k=j+1;k<m.length;k++) inc(triple, \`\${m[i]}-\${m[j]}-\${m[k]}\`);} const pairs=[...pair.entries()].sort((a,b)=>b[1]-a[1]).slice(0,30).map(e=>e[0].split('-').map(Number)); const tris=[...triple.entries()].sort((a,b)=>b[1]-a[1]).slice(0,20).map(e=>e[0].split('-').map(Number)); if(Math.random()<0.5 && tris.length){ main=[...tris[Math.floor(Math.random()*tris.length)]]; } else if(pairs.length){ main=[...pairs[Math.floor(Math.random()*pairs.length)]]; } while(main.length<5){ const add=pick(1,50,main,1); if(add.length) main.push(add[0]); else break; } main.sort((a,b)=>a-b); return {main, euro:euroAuto()}; }
  if(mode==='groups'){ const want=$$('#groupControls select').map(s=>+s.value||0); const sumWant=sum(want); if(sumWant!==5){ $('#groupError').classList.remove('hidden'); $('#groupError').textContent='Bitte genau 5 aus den Gruppen wählen.'; throw new Error('Gruppen nicht vollständig.'); } main=[]; [{from:1,to:10},{from:11,to:20},{from:21,to:30},{from:31,to:40},{from:41,to:50}].forEach((g,i)=>{ const need=want[i]; if(need>0){ main.push(...pick(g.from,g.to,main,need)); } }); main=Array.from(new Set(main)).sort((a,b)=>a-b).slice(0,5); let euro=[]; if($('#useEuro').checked){ const eWant=$$('#euroControls select').map(s=>+s.value||0); const eSum=sum(eWant); if(!(eSum===0 || eSum===2)){ throw new Error('Euro-Summe muss 0 oder 2 sein.'); } if(eSum===2){ [{from:1,to:6},{from:7,to:12}].forEach((g,i)=>{ const need=eWant[i]; if(need>0){ euro.push(...pick(g.from,g.to,euro,need)); } }); euro.sort((a,b)=>a-b); } if(eSum===0){ euro=euroAuto(); } } else { euro=euroAuto(); } return {main,euro}; }
  return {main:pick(1,50,[],5).sort((a,b)=>a-b), euro:euroAuto()};
}
async function typeLine(el, text){ for(const ch of text){ el.append(ch); await sleep(10);} }
async function printTip(outEl, index, tip){ await typeLine(outEl, "#"+index+": "); for(const n of tip.main){ await typeLine(outEl, n+" "); } await typeLine(outEl, "|  E: "); for(const e of tip.euro){ await typeLine(outEl, e+" "); } outEl.append("\n"); outEl.scrollTop=outEl.scrollHeight; }
$('#generateBtn').addEventListener('click', async ()=>{
  if(!draws.length){ alert('Bitte zuerst ein Archiv laden.'); return; }
  if($('#modus').value==='groups' && $('#groupControls').children.length===0){ buildGroupUI(); }
  const total=+$('#kombis').value||1; const out=$('#liveOutput'); out.textContent=''; generated=[]; const seen=new Set();
  for(let i=1;i<=total;i++){ try{ let tip=generateOne(); let key=tip.main.join('-')+'|'+tip.euro.join('-'); let guard=0; while(seen.has(key) && guard<10){ tip=generateOne(); key=tip.main.join('-')+'|'+tip.euro.join('-'); guard++; } seen.add(key); generated.push(tip); await animateSelection(tip.main, tip.euro); await printTip(out, i, tip); }catch(e){ break; } }
});
$('#clearGeneratedBtn').addEventListener('click', ()=>{ generated=[]; $('#liveOutput').textContent=''; });

/* ===== Analyse All ===== */
$('#analyseAllBtn').addEventListener('click', ()=>{
  if(!generated.length){ alert('Bitte zuerst Varianten generieren.'); return; }
  const dist=Array(8).fill(0);
  generated.forEach(t=>{ for(const d of draws){ const ov=t.main.filter(x=>d.main.includes(x)).length + t.euro.filter(x=>d.euro.includes(x)).length; dist[ov]++; } });
  const body = dist.map((v,i)=>`<tr><td class="px-2 py-1">${i}</td><td class="px-2 py-1">${v}</td></tr>`).join('');
  $('#analysisBox').innerHTML = `<div class="glass mt-2"><div class="font-bold mb-2">Overlap‑Verteilung (alle Varianten × Archiv)</div><table class="text-sm"><thead><tr><th class="px-2 py-1">Treffer</th><th class="px-2 py-1">Anzahl</th></tr></thead><tbody>${body}</tbody></table></div>`;
  tab('ana', $('#btn-ana'));
});

/* ===== Favoriten (minimal implementiert) ===== */
function renderFavs(){ const q=($('#favSearch')?.value||'').toLowerCase(); const box=$('#favoritesBox'); if(!box) return; box.innerHTML=''; favorites.filter(f=> (f.main.join(' ')+' '+f.euro.join(' ')).toLowerCase().includes(q)).forEach((f,i)=>{ const div=document.createElement('div'); div.className='glass p-3'; div.innerHTML = `<div class="flex items-center gap-2 flex-wrap">${f.main.map(n=>`<span class='chip'>${n}</span>`).join('')}<span class="badge">Euro</span>${f.euro.map(n=>`<span class='chip euro'>${n}</span>`).join('')}</div><div class="mt-2 flex gap-2"><button class="btn btn--gray" onclick='navigator.clipboard.writeText("${f.main.join('-')} | E:${f.euro.join('-')}")'>Copy</button><button class="btn btn--gray" onclick='animateSelection(${JSON.stringify(f.main)}, ${JSON.stringify(f.euro)})'>Show</button><button class="btn btn--gray" onclick="favorites.splice(${i},1); localStorage.setItem('ej_favs_v1', JSON.stringify(favorites)); renderFavs();">Entfernen</button></div>`; box.appendChild(div); }); }
$('#favSearch')?.addEventListener('input', renderFavs);
['favExport','favCSV','favImport','favClear'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; });
renderFavs();

/* ===== Restore archive on start ===== */
(()=>{ const saved=localStorage.getItem(ARCH_KEY); if(saved){ try{ parseArchiveText(saved); $('#statusText').textContent='Archiv aus Speicher geladen ✔'; }catch{} } })();
</script>

</body>
</html>
