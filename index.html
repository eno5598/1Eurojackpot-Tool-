<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Eurojackpot ‚Ä¢ Ultra v5 (vollst√§ndig)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
  :root{--ink:#eaf2ff;--mut:#a9b7dd;--bg:#0a1124;--panel:#0f1836;--panel2:#0c1328;--gl1:#39ffd7;--gl2:#7c5cff;--ok:#3cff93;--warn:#ff6b6b}
  body{background:radial-gradient(60rem 60rem at 120% -10%, rgba(124,92,255,.18),transparent 60%),radial-gradient(60rem 60rem at -10% 110%, rgba(57,255,215,.12),transparent 60%),var(--bg);color:var(--ink)}
  .cardx{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid rgba(143,170,255,.22);border-radius:16px;padding:12px;margin-bottom:12px;box-shadow:0 14px 30px rgba(0,0,0,.35)}
  .chip{display:inline-flex;min-width:22px;height:22px;border-radius:7px;align-items:center;justify-content:center;margin:2px 3px;padding:0 6px;background:#12224a;border:1px solid rgba(143,170,255,.25);font-weight:800}
  .chip.e{background:#1b2a3f}
  .chip.typing{box-shadow:0 0 0 2px var(--ok),0 0 16px var(--ok)}
  .chip.done{box-shadow:0 0 0 2px var(--gl1),0 0 12px var(--gl1)}
  .band{border:1px solid rgba(143,170,255,.2);border-radius:12px;padding:6px 8px;margin-bottom:6px}
  .grad{height:6px;border-radius:999px;background:linear-gradient(90deg,#6ea0ff,#7c5cff);margin-bottom:6px}
  .grad.g2{background:linear-gradient(90deg,#6bffc0,#0aa771)}
  .grad.g3{background:linear-gradient(90deg,#d19aff,#6f36ff)}
  .grad.g4{background:linear-gradient(90deg,#ffd36b,#c67a00)}
  .grad.g5{background:linear-gradient(90deg,#ff8989,#c32020)}
  .grad.ge1{background:linear-gradient(90deg,#ffe066,#9c7a00)}
  .grad.ge2{background:linear-gradient(90deg,#66ffe6,#0aa3a3)}
  .sticky{position:fixed;left:0;right:0;bottom:0;background:rgba(9,15,34,.92);border-top:1px solid rgba(143,170,255,.2);backdrop-filter:blur(8px);z-index:6}
  .progress-neon{height:8px;background:rgba(143,170,255,.18);border-radius:999px;overflow:hidden}
  .progress-neon>i{display:block;height:100%;background:linear-gradient(90deg,var(--gl1),var(--gl2));width:0%}
  .overlay{position:fixed;inset:0;background:rgba(5,10,20,.7);display:none;align-items:center;justify-content:center;z-index:10;backdrop-filter:blur(4px)}
  .holo{width:220px;height:220px;border-radius:50%;border:2px solid rgba(124,92,255,.35);box-shadow: inset 0 0 40px rgba(57,255,215,.25),0 0 40px rgba(124,92,255,.25);display:flex;align-items:center;justify-content:center;color:#dfe8ff;font-weight:900;letter-spacing:.2em}
  .pill{font-size:.75rem;border:1px solid rgba(143,170,255,.3);border-radius:999px;padding:.1rem .5rem}
  .fav-toggle{position:fixed;right:14px;top:14px;z-index:7}
  .fav{position:fixed;right:0;top:0;bottom:0;width:360px;max-width:92vw;background:linear-gradient(180deg,rgba(16,24,54,.98),rgba(12,18,40,.98));border-left:1px solid rgba(143,170,255,.2);transform:translateX(100%);transition:.3s;z-index:8}
  .fav.open{transform:translateX(0)}
  .fav .hdr{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(143,170,255,.2)}
  .fav .body{padding:10px;overflow:auto;height:calc(100% - 50px)}
</style>
</head>
<body>
<button class="btn btn-warning fav-toggle" id="favToggle">‚≠ê Favoriten</button>
<div class="fav" id="favPanel">
  <div class="hdr">
    <div class="fw-bold">‚≠ê Favoriten</div>
    <div class="d-flex gap-2">
      <button class="btn btn-sm btn-outline-light" id="favExport">Export CSV</button>
      <button class="btn btn-sm btn-outline-danger" id="favClear">Leeren</button>
      <button class="btn btn-sm btn-outline-secondary" id="favClose">Schlie√üen</button>
    </div>
  </div>
  <div class="body" id="favBody"></div>
</div>

<div class="container py-3 pb-5">
  <div class="cardx">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">3) Map (1‚Äì50) & Euro (1‚Äì12)</h5>
      <span id="label" class="pill">Bereit</span>
    </div>
    <div class="progress-neon my-2"><i id="pbar"></i></div>
    <div id="mwrap"></div>
    <h6 class="mt-2">Eurozahlen</h6>
    <div id="ewrap"></div>
  </div>

  <div class="row g-2">
    <div class="col-lg-6">
      <div class="cardx">
        <h5>1) Archiv</h5>
        <div class="small">Status: <span id="ast">Kein Archiv</span></div>
        <div class="row g-2 mt-1">
          <div class="col-8"><input id="url" class="form-control form-control-sm" placeholder="Archiv-URL" value="https://www.lotto-bayern.de/static/gamebroker_2/de/download_files/archiv_eurojackpot.zip"></div>
          <div class="col-4"><button id="loadUrl" class="btn btn-primary w-100 btn-sm">Vom Link laden</button></div>
          <div class="col-12"><input id="file" type="file" class="form-control form-control-sm" accept=".zip,.txt,.csv"></div>
        </div>
        <div class="row text-center mt-2">
          <div class="col-3"><div class="small text-secondary">Ziehungen</div><div id="kCount" class="fw-bold">‚Äì</div></div>
          <div class="col-3"><div class="small text-secondary">Von</div><div id="kFrom" class="fw-bold">‚Äì</div></div>
          <div class="col-3"><div class="small text-secondary">Bis</div><div id="kTo" class="fw-bold">‚Äì</div></div>
          <div class="col-3"><div class="small text-secondary">Aktuell?</div><div id="kFresh" class="fw-bold">‚Äì</div></div>
        </div>
        <div class="mt-2 d-flex gap-2 flex-wrap">
          <button class="btn btn-outline-info btn-sm" id="saveA">Archiv speichern</button>
          <button class="btn btn-outline-warning btn-sm" id="loadA">Gespeichertes laden</button>
          <button class="btn btn-outline-danger btn-sm" id="clearA">Archiv l√∂schen</button>
        </div>
      </div>

      <div class="cardx">
        <h5>2) Einstellungen</h5>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label small">Kombinationen</label>
            <select id="n" class="form-select form-select-sm"></select>
          </div>
          <div class="col-6">
            <label class="form-label small">Modus</label>
            <select id="mode" class="form-select form-select-sm">
              <option value="never">Nie gezogene</option>
              <option value="last100">Letzte 100</option>
              <option value="hot">Hot Paare/Triples</option>
              <option value="groups">5er-Gruppen</option>
              <option value="complex">Komplex</option>
              <option value="runs">Folgen-Zahlen</option>
            </select>
          </div>
        </div>
        <div id="groups" class="mt-2" style="display:none">
          <div class="d-flex justify-content-between align-items-center">
            <div class="small text-secondary">Summe ‚â§ 5</div>
            <div id="gc" class="pill">0/‚â§5</div>
          </div>
          <div id="gCtrls" class="mt-1"></div>
          <div class="form-check form-switch mt-2">
            <input id="euroOn" class="form-check-input" type="checkbox">
            <label class="form-check-label" for="euroOn">Eurozahlen manuell (0/2)</label>
          </div>
          <div id="eCtrls" class="mt-1" style="display:none"></div>
        </div>
        <div id="note" class="small text-info mt-1">Eurozahlen werden automatisch auf 2 gesetzt (au√üer im Gruppenmodus mit Schalter).</div>
      </div>

      <div class="cardx">
        <h5>5) Analyse</h5>
        <div class="row g-1">
          <div class="col-9"><input id="wishM" class="form-control form-control-sm" placeholder="5 Hauptzahlen z. B. 1 12 23 34 45"></div>
          <div class="col-3"><input id="wishE" class="form-control form-control-sm" placeholder="Euro (0/2)"></div>
        </div>
        <div class="mt-2 d-flex gap-2 flex-wrap">
          <button id="analyseTip" class="btn btn-success btn-sm">Tipp analysieren</button>
          <button id="fromLast" class="btn btn-outline-light btn-sm">Aus letzter Variante</button>
          <button id="analyseAll" class="btn btn-outline-info btn-sm">Alle Varianten analysieren</button>
          <button id="csvAll" class="btn btn-outline-warning btn-sm">CSV Export (Varianten)</button>
        </div>
        <div id="ana" class="mt-2 small"></div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="cardx">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="m-0">4) Generieren</h5>
          <div id="prog" class="small">‚Äì</div>
        </div>
        <div id="live" class="mt-2" style="height:140px;overflow:auto;background:#0d1933;border:1px solid rgba(143,170,255,.2);border-radius:8px;padding:8px;font-family:ui-monospace,Consolas"></div>
        <div id="cards" class="mt-2"></div>
      </div>
    </div>
  </div>
</div>

<div class="sticky py-2">
  <div class="container">
    <div class="row g-2">
      <div class="col-4"><button id="gen" class="btn btn-primary w-100">‚ö° Generieren</button></div>
      <div class="col-4"><button id="gotoAna" class="btn btn-outline-light w-100">üìà Analysieren</button></div>
      <div class="col-4"><button id="favAdd" class="btn btn-outline-warning w-100">‚≠ê Favorit speichern</button></div>
    </div>
  </div>
</div>

<div class="overlay" id="ov"><div class="holo">KOMPLEX‚ÄëANALYSE</div></div>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a;}
function uniqueSorted(a){return Array.from(new Set(a)).sort((x,y)=>x-y);}
function iso(y,m,d){const dt=new Date(+y,+m-1,+d);return isNaN(dt)?null:dt.toISOString().slice(0,10);}

const LS_ARCH='ej_arch_v5', LS_RAW='ej_arch_raw_v5', LS_FAV='ej_favs_v5';
let draws=[], freqM=Array(51).fill(0), freqE=Array(13).fill(0), lastM=Array(51).fill(null), lastE=Array(13).fill(null);
let generated=[], lastTip=null, favs=[];

for(let i=1;i<=25;i++){const o=document.createElement('option');o.value=i;o.textContent=i;$('#n').appendChild(o);}
const GROUPS=[['1‚Äì10',1,10,'g1'],['11‚Äì20',11,20,'g2'],['21‚Äì30',21,30,'g3'],['31‚Äì40',31,40,'g4'],['41‚Äì50',41,50,'g5']];
const EG=[['1‚Äì6',1,6,'ge1'],['7‚Äì12',7,12,'ge2']];
function buildMap(){
  const m=$('#mwrap'); m.innerHTML='';
  GROUPS.forEach((g,ix)=>{
    const d=document.createElement('div'); d.className='band';
    d.innerHTML=`<div class="grad ${g[3]}"></div>`;
    const r=document.createElement('div');
    for(let n=g[1];n<=g[2];n++){ const c=document.createElement('div'); c.className='chip'; c.dataset.num=n; c.textContent=n; r.appendChild(c); }
    d.appendChild(r); m.appendChild(d);
  });
  const e=$('#ewrap'); e.innerHTML='';
  EG.forEach(g=>{
    const d=document.createElement('div'); d.className='band';
    d.innerHTML=`<div class="grad ${g[3]}"></div>`;
    const r=document.createElement('div');
    for(let n=g[1];n<=g[2];n++){ const c=document.createElement('div'); c.className='chip e'; c.dataset.enum=n; c.textContent=n; r.appendChild(c); }
    d.appendChild(r); e.appendChild(d);
  });
}
buildMap();

function buildGroupCtrls(){
  const host=$('#gCtrls'); host.innerHTML='';
  GROUPS.forEach((g,i)=>{
    const row=document.createElement('div'); row.className='d-flex align-items-center justify-content-between mb-1';
    row.innerHTML=`<div class="fw-bold">${g[0]}</div>`;
    const sel=document.createElement('select'); sel.className='form-select form-select-sm'; sel.style.width='80px';
    for(let v=0;v<=5;v++){const o=document.createElement('option');o.value=v;o.textContent=v;sel.appendChild(o);}
    sel.onchange=updateGroupCounter;
    row.appendChild(sel); host.appendChild(row);
  });
  const eh=$('#eCtrls'); eh.innerHTML='';
  EG.forEach((g,i)=>{
    const row=document.createElement('div'); row.className='d-flex align-items-center justify-content-between mb-1';
    row.innerHTML=`<div class="fw-bold">${g[0]}</div>`;
    const sel=document.createElement('select'); sel.className='form-select form-select-sm'; sel.style.width='80px';
    for(let v=0;v<=2;v++){const o=document.createElement('option');o.value=v;o.textContent=v;sel.appendChild(o);}
    sel.onchange=updateEuroCounter;
    row.appendChild(sel); eh.appendChild(row);
  });
}
buildGroupCtrls();
function updateGroupCounter(){const s=$$('#gCtrls select').reduce((a,x)=>a+ +x.value,0);$('#gc').textContent=s+'/‚â§5';}
function updateEuroCounter(){const s=$$('#eCtrls select').reduce((a,x)=>a+ +x.value,0);$('#gcE').textContent=s+'/2';}

$('#mode').addEventListener('change',()=>{
  const on=$('#mode').value==='groups';
  $('#groups').style.display=on?'block':'none';
  $('#note').style.display=on?'none':'block';
});
$('#euroOn').addEventListener('change',()=>{$('#eCtrls').style.display=$('#euroOn').checked?'block':'none';});

/* ======= Archiv ======= */
$('#file').addEventListener('change', async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  let txt='';
  if(f.name.toLowerCase().endsWith('.zip')){
    const zip=await JSZip.loadAsync(f);
    const entry=Object.values(zip.files).find(x=>/\.(txt|csv)$/i.test(x.name));
    txt=await entry.async('string');
  }else{
    txt=await f.text();
  }
  parseArchive(txt,true);
});
$('#loadUrl').addEventListener('click', async()=>{
  try{
    $('#ast').textContent='Lade vom Link‚Ä¶';
    const r=await fetch($('#url').value, {mode:'cors'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const blob=await r.blob();
    if($('#url').value.endsWith('.zip')){
      const zip=await JSZip.loadAsync(blob);
      const entry=Object.values(zip.files).find(x=>/\.(txt|csv)$/i.test(x.name));
      const txt=await entry.async('string');
      parseArchive(txt,true);
    }else{
      const txt = await blob.text();
      parseArchive(txt,true);
    }
  }catch(err){
    $('#ast').textContent='CORS/Download fehlgeschlagen ‚Äì bitte Datei manuell laden.';
  }
});
$('#saveA').addEventListener('click',()=>{
  if(!draws.length){alert('Kein Archiv im Speicher');return;}
  localStorage.setItem(LS_ARCH, JSON.stringify({draws,freqM,freqE,lastM,lastE}));
  localStorage.setItem(LS_RAW, window.__raw||'');
  $('#ast').textContent='Archiv gespeichert ‚úî';
});
$('#loadA').addEventListener('click',()=>{
  const s=localStorage.getItem(LS_ARCH), raw=localStorage.getItem(LS_RAW);
  if(!s){alert('Kein gespeichertes Archiv');return;}
  const obj=JSON.parse(s); draws=obj.draws; freqM=obj.freqM; freqE=obj.freqE; lastM=obj.lastM; lastE=obj.lastE;
  window.__raw=raw||''; updateKPIs(); $('#ast').textContent='Archiv aus Speicher ‚úî';
});
$('#clearA').addEventListener('click',()=>{
  localStorage.removeItem(LS_ARCH); localStorage.removeItem(LS_RAW);
  draws=[]; freqM.fill(0); freqE.fill(0); lastM.fill(null); lastE.fill(null);
  updateKPIs(true); $('#ast').textContent='Archiv gel√∂scht';
});

function parseArchive(txt, save){
  window.__raw = txt;
  const lines = txt.replace(/\r\n?/g,'\n').split('\n').map(l=>l.trim()).filter(Boolean);
  const regDMY=/^(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})$/; const regYMD=/^(\d{4})[.\-/](\d{1,2})[.\-/](\d{1,2})$/;
  function parseLine(line){
    const t=line.split(/;|,|\t|\s+/).filter(Boolean); let date=null,rest=[];
    if(t[0]){
      if(regDMY.test(t[0])){const m=t[0].match(regDMY); date=iso(m[3],m[2],m[1]); rest=t.slice(1);}
      else if(regYMD.test(t[0])){const m=t[0].match(regYMD); date=iso(m[1],m[2],m[3]); rest=t.slice(1);}
      else rest=t.slice();
    }
    const nums=rest.map(Number).filter(n=>!Number.isNaN(n));
    const main=nums.filter(n=>n>=1&&n<=50).slice(0,5).sort((a,b)=>a-b);
    const euro=nums.filter(n=>n>=1&&n<=12).slice(0,2).sort((a,b)=>a-b);
    if(!date||main.length!==5||euro.length!==2) return null;
    return {date,main,euro};
  }
  draws=[]; freqM.fill(0); freqE.fill(0); lastM.fill(null); lastE.fill(null);
  for(const l of lines){const r=parseLine(l); if(r) draws.push(r);}
  draws.sort((a,b)=>a.date.localeCompare(b.date));
  draws.forEach((d,i)=>{ d.main.forEach(n=>{freqM[n]++; lastM[n]=i}); d.euro.forEach(n=>{freqE[n]++; lastE[n]=i}); });
  updateKPIs();
  $('#ast').textContent='Archiv geladen ‚úî';
  if(save){ localStorage.setItem(LS_ARCH, JSON.stringify({draws,freqM,freqE,lastM,lastE})); localStorage.setItem(LS_RAW, txt); }
}
function updateKPIs(empty){
  if(!draws.length||empty){ $('#kCount').textContent='‚Äì';$('#kFrom').textContent='‚Äì';$('#kTo').textContent='‚Äì';$('#kFresh').textContent='‚Äì'; return; }
  $('#kCount').textContent=draws.length;
  $('#kFrom').textContent=draws[0].date;
  $('#kTo').textContent=draws.at(-1).date;
  const dd=Math.round((Date.now()-new Date(draws.at(-1).date))/86400000);
  $('#kFresh').textContent=dd<=14?'ja':'alt';
}

/* ======= Generator ======= */
function pickRange(from,to,avoid,count,weight){
  const bag=[]; for(let n=from;n<=to;n++){ if(!avoid.includes(n)){ let w=weight?weight(n):1; w=Math.max(1,Math.floor(w)); for(let k=0;k<w;k++) bag.push(n);} }
  shuffle(bag); const res=[];
  for(const v of bag){ if(!res.includes(v)){ res.push(v); if(res.length===count) break; } }
  return res;
}
function euroAuto(){
  const lastIdx=draws.length-1;
  const w = (e)=>{
    const f = freqE[e]/Math.max(1,Math.max(...freqE.slice(1)));
    const gap = lastE[e]==null ? lastIdx+1 : (lastIdx-lastE[e]);
    const gn = Math.min(1, gap/(lastIdx+1));
    return 1 + Math.round(3*(0.55*f + 0.45*gn));
  };
  let e = pickRange(1,12,[],2,w);
  if(e.length<2){
    const pool=Array.from({length:12},(_,i)=>i+1).filter(x=>!e.includes(x)); shuffle(pool);
    while(e.length<2 && pool.length) e.push(pool.pop());
  }
  return e.sort((a,b)=>a-b);
}
function ensureFive(main, weight=null){
  let m = uniqueSorted(main).slice(0,5);
  while(m.length<5){
    const add = pickRange(1,50,m,1,weight);
    if(add.length) m = uniqueSorted(m.concat(add));
    else{
      const pool=Array.from({length:50},(_,i)=>i+1).filter(x=>!m.includes(x)); shuffle(pool);
      while(m.length<5 && pool.length) m.push(pool.pop());
      m=uniqueSorted(m);
    }
  }
  return m.slice(0,5);
}

/* Komplex (kompakte SA) */
function genComplex(){
  const fN=n=>freqM[n]/Math.max(1,Math.max(...freqM.slice(1)));
  const gN=n=>{const li=lastM[n]==null?-1:lastM[n]; return li<0?1:(draws.length-1-li)/draws.length;};
  const w=n=>1+Math.round(5*(0.6*gN(n)+0.4*fN(n)));
  let cur=ensureFive([],w), best=cur.slice();
  function score(set){
    let s=set.reduce((a,x)=>a+0.5*fN(x)+0.8*gN(x),0);
    const cnt=[0,0,0,0,0]; set.forEach(n=>cnt[Math.floor((n-1)/10)]++);
    const bal = cnt.reduce((a,c)=>a+Math.abs(c-1),0); s += Math.max(0,5-bal)/5;
    return s;
  }
  let cs=score(cur), bs=cs; const ITER=1200;
  for(let t=0;t<ITER;t++){
    const c=cur.slice(); const rm=Math.floor(Math.random()*c.length);
    const avoid=c.slice(); avoid.splice(rm,1);
    const add=pickRange(1,50,avoid,1,w); if(add.length) c[rm]=add[0];
    c.sort((a,b)=>a-b); const sc=score(c);
    if(sc>cs || Math.random()<Math.exp((sc-cs)/(0.12+1e-4))){ cur=c; cs=sc; if(sc>bs){best=c; bs=sc;} }
  }
  return best;
}

/* Folgen-Zahlen (Runs) */
function genRuns(){
  const runMap=new Map(); const inc=(k)=>runMap.set(k,(runMap.get(k)||0)+1);
  for(const d of draws){
    const m=[...d.main].sort((a,b)=>a-b); let seq=[m[0]];
    for(let i=1;i<m.length;i++){
      if(m[i]===m[i-1]+1) seq.push(m[i]); else{
        if(seq.length>=2){ for(let L=2;L<=Math.min(4,seq.length);L++) for(let s=0;s+L<=seq.length;s++) inc(seq.slice(s,s+L).join('-')); }
        seq=[m[i]];
      }
    }
    if(seq.length>=2){ for(let L=2;L<=Math.min(4,seq.length);L++) for(let s=0;s+L<=seq.length;s++) inc(seq.slice(s,s+L).join('-')); }
  }
  const lastIdx=draws.length-1, score=[];
  for(const [k,v] of runMap.entries()){
    const nums=k.split('-').map(Number);
    const minLast=Math.min(...nums.map(n=> lastM[n]==null?-1:lastM[n]));
    const gap=minLast<0? lastIdx+1 : (lastIdx-minLast);
    const fresh=1 + gap/(lastIdx+1);
    score.push([nums, v*fresh]);
  }
  score.sort((a,b)=>b[1]-a[1]);
  const base=score.length? score[Math.floor(Math.random()*Math.min(12,score.length))][0] : [];
  return ensureFive(base, n=>1);
}

function genOne(){
  const mode=$('#mode').value;
  const recent = draws.slice(-100);
  const fm = Array(51).fill(1); recent.forEach(d=>d.main.forEach(n=>fm[n]++));
  const maxM = Math.max(...fm.slice(1));
  const wRecent = n=> 1 + Math.floor(3*fm[n]/Math.max(1,maxM));

  if(mode==='groups'){
    const wish=$$('#gCtrls select').map(s=>+s.value||0);
    const sum=wish.reduce((a,b)=>a+b,0); if(sum>5) throw new Error('Gruppen-Summe > 5');
    let main=[];
    GROUPS.forEach((g,i)=>{ const need=wish[i]; if(need>0){ main=uniqueSorted(main.concat(pickRange(g[1],g[2],main,need,wRecent))); } });
    main = ensureFive(main, wRecent);
    let euro=[];
    if($('#euroOn').checked){
      const ec=$$('#eCtrls select').map(s=>+s.value||0); const es=ec.reduce((a,b)=>a+b,0);
      if(!(es===0||es===2)) throw new Error('Euro-Summe muss 0 oder 2 sein');
      if(es===2){ EG.forEach((g,i)=>{ const need=ec[i]; if(need>0){ euro=uniqueSorted(euro.concat(pickRange(g[1],g[2],euro,need))); } }); if(euro.length<2){ euro=euroAuto(); } }
    }else{ euro = euroAuto(); }
    return {main, euro};
  }
  if(mode==='never' && draws.length){ const w=n=> (freqM[n]===0?6:(freqM[n]<=5?3:1)); return {main:ensureFive([],w), euro:euroAuto()}; }
  if(mode==='last100' && draws.length){ return {main:ensureFive([],wRecent), euro:euroAuto()}; }
  if(mode==='hot' && draws.length){
    const recent=draws.slice(-200);
    const pairs=new Map(), triples=new Map();
    const inc=(m,k)=>m.set(k,(m.get(k)||0)+1);
    for(const d of recent){
      const m=[...d.main].sort((a,b)=>a-b);
      for(let i=0;i<m.length;i++) for(let j=i+1;j<m.length;j++) inc(pairs,`${m[i]}-${m[j]}`);
      for(let i=0;i<m.length;i++) for(let j=i+1;j<m.length;j++) for(let k=j+1;k<m.length;k++) inc(triples,`${m[i]}-${m[j]}-${m[k]}`);
    }
    const tp=[...pairs.entries()].sort((a,b)=>b[1]-a[1]).slice(0,40).map(e=>e[0].split('-').map(Number));
    const tt=[...triples.entries()].sort((a,b)=>b[1]-a[1]).slice(0,25).map(e=>e[0].split('-').map(Number));
    let base=[]; if(Math.random()<0.5 && tt.length) base=tt[Math.floor(Math.random()*tt.length)]; else if(tp.length) base=tp[Math.floor(Math.random()*tp.length)]; 
    return {main:ensureFive(base,wRecent), euro:euroAuto()};
  }
  if(mode==='runs' && draws.length){ return {main:genRuns(), euro:euroAuto()}; }
  if(mode==='complex' && draws.length){
    $('#ov').style.display='flex';
    try{ return {main:genComplex(), euro:euroAuto()}; }
    finally{ $('#ov').style.display='none'; }
  }
  return {main:ensureFive([]), euro:euroAuto()};
}

function clearMap(){ $$('.chip').forEach(c=>{c.classList.remove('typing','done')}); }
async function typeOnMap(tip,i,total){
  clearMap();
  const delay=$('#mode').value==='complex'?160:100;
  for(const n of tip.main){ const el=document.querySelector(`.chip[data-num="${n}"]`); if(el){el.classList.add('typing'); await sleep(delay); el.classList.remove('typing'); el.classList.add('done');}}
  for(const n of tip.euro){ const el=document.querySelector(`.chip[data-enum="${n}"]`); if(el){el.classList.add('typing'); await sleep(delay); el.classList.remove('typing'); el.classList.add('done');}}
  $('#label').textContent = `#${i}/${total}`; $('#pbar').style.width = Math.round(i/total*100)+'%';
}

function formatTip(t){return t.main.join('-') + (t.euro.length? ' | E:' + t.euro.join('-') : '');}
function addCard(idx, t){
  const c=document.createElement('div'); c.className='cardx';
  const nums=document.createElement('div');
  t.main.forEach(n=>{const d=document.createElement('span');d.className='chip';d.textContent=n;nums.appendChild(d);});
  const sep=document.createElement('span'); sep.className='chip e'; sep.textContent='E'; nums.appendChild(sep);
  t.euro.forEach(n=>{const d=document.createElement('span');d.className='chip e';d.textContent=n;nums.appendChild(d);});
  const head=document.createElement('div'); head.className='d-flex justify-content-between align-items-center';
  head.innerHTML=`<strong>#${idx}</strong>`; head.appendChild(nums); c.appendChild(head);
  const act=document.createElement('div'); act.className='mt-2 d-flex gap-2 flex-wrap';
  const bFav=document.createElement('button'); bFav.className='btn btn-outline-warning btn-sm'; bFav.textContent='‚≠ê Favorit'; bFav.onclick=()=>addFav(t);
  const bAna=document.createElement('button'); bAna.className='btn btn-outline-light btn-sm'; bAna.textContent='üìä Analysieren'; bAna.onclick=()=>analyse(t);
  act.appendChild(bFav); act.appendChild(bAna); c.appendChild(act);
  $('#cards').appendChild(c);
}

/* ======= Analyse ======= */
function analyse(t){
  const dist=Array(8).fill(0); let occ=0, idxs=[];
  for(let i=0;i<draws.length;i++){
    const d=draws[i];
    const eqMain = d.main.join(',')===t.main.join(',');
    if(eqMain) {occ++; idxs.push(i);}
    const ov = t.main.filter(x=>d.main.includes(x)).length + t.euro.filter(x=>d.euro.includes(x)).length;
    dist[ov]++;
  }
  const ov3 = dist.slice(3).reduce((a,b)=>a+b,0);
  const freqSum = t.main.reduce((s,n)=>s+freqM[n],0);
  const box=document.createElement('div'); box.className='cardx';
  const rows = dist.map((v,i)=>{
    const pct=((v/draws.length)*100).toFixed(1);
    const w=Math.round((v/Math.max(1,Math.max(...dist)))*100);
    return `<tr><td>${i}</td><td style="width:70%"><div class="progress-neon"><i style="width:${w}%"></i></div></td><td class="text-end">${v} <span class="text-secondary">(${pct}%)</span></td></tr>`;
  }).join('');
  const first = occ? draws[idxs[0]].date : '‚Äì';
  const last  = occ? draws[idxs.at(-1)].date : '‚Äì';
  let gap='‚Äì'; if(idxs.length>1){ let g=0; for(let i=1;i<idxs.length;i++) g+=idxs[i]-idxs[i-1]; gap=(g/(idxs.length-1)).toFixed(1); }
  box.innerHTML = `<div><strong>Analyse:</strong> ${formatTip(t)}</div>
  <div class="small text-secondary">Vorkommen (exakt): <b>${occ}</b> ‚Äî Erstes: <b>${first}</b> ‚Äî Letztes: <b>${last}</b> ‚Äî √ò Abstand: <b>${gap}</b> ‚Äî Overlap ‚â•3: <b>${ov3}</b> ‚Äî Frequenzsumme: <b>${freqSum}</b></div>
  <div class="table-responsive mt-2"><table class="table table-dark table-sm align-middle">
  <thead><tr><th>Treffer</th><th>Verteilung</th><th class="text-end">Anzahl</th></tr></thead><tbody>${rows}</tbody></table></div>`;
  $('#ana').prepend(box);
}
$('#analyseTip').addEventListener('click', ()=>{
  if(!draws.length){alert('Archiv fehlt');return;}
  const m=$('#wishM').value.trim().split(/\s+|,|;|-/).map(Number).filter(n=>n>=1&&n<=50);
  const e=$('#wishE').value.trim()? $('#wishE').value.trim().split(/\s+|,|;|-/).map(Number).filter(n=>n>=1&&n<=12):[];
  if(m.length!==5){alert('5 Hauptzahlen angeben');return;}
  if(!(e.length===0||e.length===2)){alert('Euro 0 oder 2');return;}
  analyse({main:uniqueSorted(m).slice(0,5), euro:uniqueSorted(e).slice(0,2)});
});
$('#fromLast').addEventListener('click',()=>{
  if(!lastTip){alert('Noch keine Variante');return;}
  $('#wishM').value=lastTip.main.join(' '); $('#wishE').value=lastTip.euro.join(' ');
  analyse(lastTip);
});
$('#analyseAll').addEventListener('click',()=>{
  if(!generated.length){alert('Keine Varianten');return;}
  $('#ana').innerHTML=''; generated.forEach(t=>analyse(t));
});
$('#csvAll').addEventListener('click',()=>{
  if(!generated.length){alert('Keine Varianten');return;}
  const rows = generated.map((t,i)=>[i+1, ...t.main, ...(t.euro.length?t.euro:['',''])].join(','));
  const header='Index,N1,N2,N3,N4,N5,E1,E2\n';
  const blob=new Blob([header+rows.join('\n')],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='varianten.csv'; a.click(); URL.revokeObjectURL(a.href);
});

/* ======= Favoriten ======= */
function loadFavs(){ try{favs=JSON.parse(localStorage.getItem(LS_FAV) || '[]');}catch{favs=[];} renderFavs(); }
function saveFavs(){ localStorage.setItem(LS_FAV, JSON.stringify(favs)); }
function addFav(t){ favs.push(t); saveFavs(); renderFavs(); $('#favPanel').classList.add('open'); }
function delFav(i){ favs.splice(i,1); saveFavs(); renderFavs(); }
function renderFavs(){
  const host=$('#favBody'); host.innerHTML='';
  if(!favs.length){ host.innerHTML='<div class="text-secondary">Keine Favoriten.</div>'; return; }
  favs.forEach((t,i)=>{
    const c=document.createElement('div'); c.className='cardx';
    const nums=document.createElement('div');
    t.main.forEach(n=>{const d=document.createElement('span');d.className='chip';d.textContent=n;nums.appendChild(d);});
    const sep=document.createElement('span'); sep.className='chip e'; sep.textContent='E'; nums.appendChild(sep);
    t.euro.forEach(n=>{const d=document.createElement('span');d.className='chip e';d.textContent=n;nums.appendChild(d);});
    const actions=document.createElement('div'); actions.className='mt-2 d-flex gap-2';
    const bMap=document.createElement('button'); bMap.className='btn btn-outline-light btn-sm'; bMap.textContent='üëÅ Map'; bMap.onclick=()=>{document.getElementById('mwrap').scrollIntoView({behavior:'smooth'}); typeOnMap(t,1,1);};
    const bAna=document.createElement('button'); bAna.className='btn btn-success btn-sm'; bAna.textContent='üìä Analysieren'; bAna.onclick=()=>analyse(t);
    const bDel=document.createElement('button'); bDel.className='btn btn-outline-danger btn-sm'; bDel.textContent='üóë'; bDel.onclick=()=>delFav(i);
    actions.append(bMap,bAna,bDel);
    c.append(nums,actions);
    host.appendChild(c);
  });
}
$('#favToggle').addEventListener('click',()=>$('#favPanel').classList.toggle('open'));
$('#favClose').addEventListener('click',()=>$('#favPanel').classList.remove('open'));
$('#favClear').addEventListener('click',()=>{ if(confirm('Alle Favoriten l√∂schen?')){ favs=[]; saveFavs(); renderFavs(); } });
$('#favExport').addEventListener('click',()=>{
  if(!favs.length){alert('Keine Favoriten');return;}
  const rows = favs.map((t,i)=>[i+1, ...t.main, ...(t.euro.length?t.euro:['',''])].join(','));
  const header='Index,N1,N2,N3,N4,N5,E1,E2\n';
  const blob=new Blob([header+rows.join('\n')],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='favoriten.csv'; a.click(); URL.revokeObjectURL(a.href);
});
$('#favAdd').addEventListener('click',()=>{ if(!lastTip){alert('Noch keine Variante');return;} addFav(lastTip); });

/* ======= Generieren ======= */
function formatTip(t){return t.main.join('-') + (t.euro.length? ' | E:' + t.euro.join('-') : '');}
function addCardAfterGen(i,t){ $('#live').textContent += '#'+i+': '+formatTip(t)+'\n'; addCard(i,t); }

$('#gen').addEventListener('click', async ()=>{
  if(!draws.length){ alert('Bitte erst Archiv laden.'); return; }
  const total=+$('#n').value||1; $('#cards').innerHTML=''; $('#live').textContent=''; $('#pbar').style.width='0%';
  generated=[]; lastTip=null;
  const seen=new Set();
  for(let i=1;i<=total;i++){
    let t=genOne(); t.main=ensureFive(t.main);
    if($('#mode').value!=='groups' || !$('#euroOn').checked || $$('#eCtrls select').reduce((a,x)=>a+ +x.value,0)!==0){ t.euro=euroAuto(); } else { t.euro=[]; }
    let key=t.main.join('-')+'|'+t.euro.join('-'); let guard=0;
    while(seen.has(key) && guard<10){ t=genOne(); t.main=ensureFive(t.main); t.euro=euroAuto(); key=t.main.join('-')+'|'+t.euro.join('-'); guard++; }
    seen.add(key);
    generated.push(t); lastTip=t;
    await typeOnMap(t,i,total); addCardAfterGen(i,t);
  }
});
$('#gotoAna').addEventListener('click',()=>$('#ana').scrollIntoView({behavior:'smooth'}));

/* ======= Analyse UI ======= */
$('#analyseAll').addEventListener('click',()=>{
  if(!generated.length){alert('Keine Varianten');return;}
  $('#ana').innerHTML=''; generated.forEach(t=>analyse(t));
});
$('#analyseTip').addEventListener('click', ()=>{
  if(!draws.length){alert('Archiv fehlt');return;}
  const m=$('#wishM').value.trim().split(/\s+|,|;|-/).map(Number).filter(n=>n>=1&&n<=50);
  const e=$('#wishE').value.trim()? $('#wishE').value.trim().split(/\s+|,|;|-/).map(Number).filter(n=>n>=1&&n<=12):[];
  if(m.length!==5){alert('5 Hauptzahlen angeben');return;}
  if(!(e.length===0||e.length===2)){alert('Euro 0 oder 2');return;}
  analyse({main:uniqueSorted(m).slice(0,5), euro:uniqueSorted(e).slice(0,2)});
});
$('#fromLast').addEventListener('click',()=>{ if(!lastTip){alert('Noch keine Variante');return;} $('#wishM').value=lastTip.main.join(' '); $('#wishE').value=lastTip.euro.join(' '); analyse(lastTip); });

/* Init: Archiv + Favoriten laden */
(function(){
  const s=localStorage.getItem(LS_ARCH), raw=localStorage.getItem(LS_RAW);
  if(s){ const obj=JSON.parse(s); draws=obj.draws||[]; freqM=obj.freqM||freqM; freqE=obj.freqE||freqE; lastM=obj.lastM||lastM; lastE=obj.lastE||lastE; updateKPIs(); $('#ast').textContent='Archiv aus Speicher ‚úî'; }
  try{ favs=JSON.parse(localStorage.getItem(LS_FAV)||'[]'); }catch{ favs=[]; }
  renderFavs();
})();
</script>
</body>
</html>
